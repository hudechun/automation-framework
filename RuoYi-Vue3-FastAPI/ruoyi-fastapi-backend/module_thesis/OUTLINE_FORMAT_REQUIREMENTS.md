# 论文大纲格式要求规范

## 一、格式要求的重要性

为了确保系统能够正确解析和处理AI生成的大纲，**必须对AI提出严格的格式要求**，确保每次生成的大纲格式一致。

## 二、标准格式规范

### 2.1 JSON结构（必须严格遵守）

```json
{
  "title": "论文标题（字符串）",
  "chapters": [
    {
      "chapter_number": 1,  // 整数，章节编号，从1开始递增
      "chapter_title": "章节标题（字符串）",
      "sections": [  // 数组，每个章节包含2-4个小节
        {
          "section_number": "1.1",  // 字符串，小节编号格式：章节号.小节号
          "section_title": "小节标题（字符串）",
          "content_outline": "小节内容概要（字符串，简要描述该小节的主要内容）"
        }
      ]
    }
  ]
}
```

### 2.2 字段类型要求

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `title` | string | 是 | 论文标题 |
| `chapters` | array | 是 | 章节数组 |
| `chapter_number` | integer | 是 | 章节编号，从1开始递增 |
| `chapter_title` | string | 是 | 章节标题 |
| `sections` | array | 是 | 小节数组，每个章节2-4个小节 |
| `section_number` | string | 是 | 小节编号，格式：`章节号.小节号`（如："1.1", "2.3"） |
| `section_title` | string | 是 | 小节标题 |
| `content_outline` | string | 是 | 小节内容概要 |

### 2.3 格式约束

1. **必须返回纯JSON格式**，可以直接被 `json.loads()` 解析
2. **不要使用markdown代码块**（不要包含 ```json 或 ```）
3. **不要添加任何说明文字**，只返回JSON对象
4. **所有字符串字段必须使用双引号**，不要使用单引号
5. **确保JSON格式完整**，所有括号和引号正确配对
6. **章节编号必须连续**，从1开始递增
7. **小节编号格式必须正确**：`章节号.小节号`（如："1.1", "1.2", "2.1"）

## 三、AI提示词要求

### 3.1 提示词结构

提示词必须包含以下部分：

1. **论文信息**：标题、专业、学位级别、研究方向、关键词
2. **内容要求**：章节结构、小节数量、学术规范
3. **格式要求（重点）**：
   - 明确要求返回纯JSON格式
   - 提供完整的JSON结构示例
   - 强调不要使用markdown代码块
   - 强调不要添加说明文字
   - 明确字段类型要求
4. **重要约束**：列出所有格式约束条件

### 3.2 提示词示例

```
## 格式要求（必须严格遵守）：
**必须返回纯JSON格式，不要包含任何其他文字说明、markdown代码块标记或解释。**

**JSON结构必须严格按照以下格式：**
{
  "title": "论文标题（字符串）",
  "chapters": [
    {
      "chapter_number": 1,  // 整数，章节编号，从1开始递增
      "chapter_title": "章节标题（字符串）",
      "sections": [  // 数组，每个章节包含2-4个小节
        {
          "section_number": "1.1",  // 字符串，小节编号格式：章节号.小节号
          "section_title": "小节标题（字符串）",
          "content_outline": "小节内容概要（字符串，简要描述该小节的主要内容）"
        }
      ]
    }
  ]
}

## 重要约束：
1. **必须返回有效的JSON格式**，可以直接被 `json.loads()` 解析
2. **不要使用markdown代码块**（不要包含 ```json 或 ```）
3. **不要添加任何说明文字**，只返回JSON对象
4. **字段类型必须正确**：所有字段类型必须符合规范
5. **所有字符串字段必须使用双引号**，不要使用单引号
6. **确保JSON格式完整**，所有括号和引号正确配对
```

## 四、解析和验证机制

### 4.1 多级解析策略

系统采用多级解析策略，确保能够处理各种格式：

1. **直接解析**：尝试直接解析响应为JSON
2. **移除Markdown标记**：如果包含 ```json 或 ```，移除后解析
3. **正则提取**：使用正则表达式提取JSON对象
4. **格式验证**：验证必要字段和数据类型
5. **格式规范化**：自动修复常见格式问题

### 4.2 验证规则

**位置**：`ai_generation_service.py:_validate_outline_format()`

验证内容：
- ✅ 检查 `title` 字段（如果缺失，使用默认值）
- ✅ 检查 `chapters` 字段（必须是数组）
- ✅ 验证每个章节的必要字段
- ✅ 验证 `chapter_number` 类型（整数）
- ✅ 验证 `sections` 数组格式
- ✅ 验证小节编号格式
- ✅ 自动修复常见问题（缺失字段、类型错误等）

## 五、错误处理

### 5.1 解析失败处理

如果JSON解析失败，系统会：
1. 记录详细的错误日志（包含原始响应的前500字符）
2. 返回包装格式，保留原始内容：
   ```json
   {
     "title": "论文大纲",
     "content": "原始AI响应内容",
     "chapters": []
   }
   ```
3. 后续处理可以使用 `outline_parser.py` 解析 `content` 字段

### 5.2 格式不一致处理

如果格式不完全符合要求，系统会：
1. 自动验证和规范化格式
2. 修复常见问题（缺失字段、类型错误）
3. 记录警告日志
4. 尽可能提取可用数据

## 六、代码位置

1. **提示词构建**：`ai_generation_service.py:_build_outline_prompt()` (第305行)
2. **响应解析**：`ai_generation_service.py:_parse_outline_response()` (第352行)
3. **格式验证**：`ai_generation_service.py:_validate_outline_format()` (新增)
4. **大纲解析工具**：`utils/outline_parser.py` (处理多种格式兼容)

## 七、最佳实践

1. **提示词要明确**：在提示词中明确要求格式，不要依赖AI的默认行为
2. **提供示例**：在提示词中提供完整的JSON结构示例
3. **强调约束**：明确列出所有格式约束条件
4. **多级解析**：实现多级解析策略，提高容错性
5. **格式验证**：解析后验证格式，自动修复常见问题
6. **错误日志**：记录详细的错误信息，便于调试

## 八、测试建议

1. **测试不同AI模型**：不同模型可能返回格式略有差异
2. **测试边界情况**：空章节、缺失字段、类型错误等
3. **测试解析容错**：包含markdown标记、说明文字等情况
4. **验证格式一致性**：多次生成，检查格式是否一致
