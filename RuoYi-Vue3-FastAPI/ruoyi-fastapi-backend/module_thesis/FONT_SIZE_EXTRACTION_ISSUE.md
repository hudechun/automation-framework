# 字体大小提取问题分析

## 问题描述

**现象**：AI生成的格式指令中，所有字体大小都是 `45.72` 磅，明显不正常。

**正常值**：
- 正文：12磅（小四号）
- 一级标题：14-18磅
- 二级标题：12-14磅
- 三级标题：10-12磅

**异常值**：45.72磅（所有字体都是这个值）

---

## 问题根源分析

### 1. 字体大小提取方式

**当前代码**（`format_service.py` 第254行）：
```python
'font_size': str(run.font.size) if run.font.size else None,
```

**问题**：
- `run.font.size` 是 `docx.shared.Pt` 对象
- 直接转换为字符串可能显示为 `"Pt(457200)"` 或类似格式
- 或者python-docx内部使用EMU（English Metric Units）存储
  - 1磅 = 12700 EMU
  - 45.72磅 = 45.72 × 12700 = 580,644 EMU

### 2. 可能的原因

#### 原因1：单位转换错误
- AI看到的是EMU值（如 `580644`）
- AI误认为是磅值，直接使用
- 或者AI看到的是 `"Pt(457200)"` 格式，提取了错误的部分

#### 原因2：AI误识别
- AI可能将某个其他值（如行距、间距等）误认为是字体大小
- 或者AI从文档中提取了错误的格式信息

#### 原因3：提示词不够明确
- 提示词中虽然要求"必须从文档中提取"，但没有明确说明：
  - 字体大小的单位是"磅"（point）
  - 正常范围是8-30磅
  - 如何正确提取和转换

---

## 解决方案

### ✅ 方案1：修复字体大小提取（推荐）

**修改位置**：`format_service.py` 的 `_extract_document_content()` 方法

**改进**：
```python
# 修改前
'font_size': str(run.font.size) if run.font.size else None,

# 修改后
'font_size': float(run.font.size.pt) if run.font.size else None,  # 转换为磅值
```

**说明**：
- `run.font.size.pt` 返回浮点数，单位是磅
- 直接使用数值，避免字符串转换问题

---

### ✅ 方案2：增强提示词

**修改位置**：`format_service.py` 的 `_build_format_analysis_prompt()` 方法

**改进**：
在提示词中明确说明：
```
### 字体大小提取要求：
- **单位**：必须使用"磅"（point）作为单位
- **正常范围**：8-30磅（正文通常12磅，标题通常14-18磅）
- **提取方式**：
  - 如果文档中字体大小是 `Pt(144000)` 格式，需要转换为磅值：144000 / 12700 ≈ 11.34磅
  - 如果文档中字体大小是 `"12pt"` 格式，直接提取数字部分：12
  - 如果文档中字体大小是数字（如 `12`），直接使用
- **验证**：提取后必须验证是否在合理范围内（8-30磅），如果不在范围内，需要重新检查
```

---

### ✅ 方案3：提取后立即验证和修正（已实现）

**位置**：`format_service.py` 的 `_analyze_format_with_ai()` 方法

**功能**：
- 提取后立即验证
- 自动修正异常值（8-30磅范围）
- 确保指令准确

**已实现**：✅ 已在代码中实现

---

## 根本原因

### 最可能的原因

**AI在解析文档格式信息时，看到了类似这样的数据**：
```json
{
  "font_size": "Pt(580644)"  // 或 "580644"（EMU值）
}
```

**AI误认为这是字体大小，直接使用**：
```json
{
  "font_size_pt": 45.72  // 或 580644（误认为是磅值）
}
```

**但实际上**：
- `580644` 是EMU值
- 正确的磅值应该是：580644 / 12700 ≈ 45.72磅
- 如果AI看到的是 `"Pt(580644)"`，可能提取了错误的部分

---

## 修复建议

### 1. 立即修复：改进字体大小提取

**修改** `format_service.py` 第254行：
```python
# 修改前
'font_size': str(run.font.size) if run.font.size else None,

# 修改后
'font_size': float(run.font.size.pt) if run.font.size else None,
```

**同时修改** 第280行、363行、401行等所有提取字体大小的地方。

---

### 2. 增强提示词：明确单位要求

在 `_build_format_analysis_prompt()` 方法中，添加明确的字体大小提取说明。

---

### 3. 验证和修正（已实现）

在 `_analyze_format_with_ai()` 方法中，提取后立即验证和修正。

---

## 总结

**问题根源**：
1. ❌ 字体大小提取方式不正确（直接转字符串，可能包含单位信息）
2. ❌ AI提示词不够明确（没有说明单位转换）
3. ❌ AI可能误识别了单位或格式

**解决方案**：
1. ✅ 修复字体大小提取（使用 `.pt` 属性获取数值）
2. ✅ 增强提示词（明确单位要求）
3. ✅ 提取后立即验证和修正（已实现）

**结论**：问题出在**模板上传时，字体大小提取方式不正确**，导致AI看到了错误的格式信息，生成了异常的指令。
