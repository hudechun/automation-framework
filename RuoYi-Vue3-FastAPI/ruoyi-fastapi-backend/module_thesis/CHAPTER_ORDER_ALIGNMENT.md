# å¤§çº²ç”Ÿæˆå’Œç« èŠ‚å†…å®¹é¡ºåºå¯¹åº”å®ç°

## ä¸€ã€é—®é¢˜åˆ†æ

**ç”¨æˆ·éœ€æ±‚**ï¼šå¤§çº²ç”Ÿæˆå’Œç« èŠ‚å†…å®¹è¦èƒ½æŒ‰é¡ºåºå¯¹åº”ä¸Š

**é—®é¢˜**ï¼š
- å¤§çº²ç”Ÿæˆæ—¶ï¼Œç« èŠ‚é¡ºåºå¯èƒ½ä¸ç¬¦åˆæ ¼å¼æŒ‡ä»¤è¦æ±‚
- ç« èŠ‚ç”Ÿæˆæ—¶ï¼Œå¯èƒ½ä¸æŒ‰ç…§å¤§çº²é¡ºåºç”Ÿæˆ
- æ ¼å¼åŒ–æ—¶ï¼Œç« èŠ‚é¡ºåºå¯èƒ½ä¸æ­£ç¡®

---

## äºŒã€å®ç°æ–¹æ¡ˆ

### âœ… 1. å¢å¼ºå¤§çº²ç”Ÿæˆæç¤ºè¯

**æ–‡ä»¶**ï¼š`ai_generation_service.py`

**ä¿®æ”¹å†…å®¹**ï¼š
- åœ¨æ ¼å¼è¦æ±‚ä¸­æ˜ç¡®è¦æ±‚æŒ‰ç…§ `section_order` é¡ºåºç”Ÿæˆç« èŠ‚
- æ˜ç¡®è¦æ±‚ç« èŠ‚åœ¨ `chapters` æ•°ç»„ä¸­çš„é¡ºåºå¿…é¡»ä¸ `section_order` ä¸€è‡´
- æ˜ç¡®è¦æ±‚ `chapter_number` å¿…é¡»ä»1å¼€å§‹è¿ç»­é€’å¢

**å®ç°ä½ç½®**ï¼šç¬¬314-315è¡Œ

**å…³é”®ä»£ç **ï¼š
```python
# å¦‚æœæœ‰section_orderï¼Œæ˜ç¡®è¦æ±‚æŒ‰ç…§é¡ºåºç”Ÿæˆ
order_instruction = ""
if document_structure and section_order:
    order_instruction = f"\n\n**ç« èŠ‚é¡ºåºè¦æ±‚**ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š\nè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºç”Ÿæˆç« èŠ‚ï¼Œç« èŠ‚ç¼–å·ï¼ˆchapter_numberï¼‰ä»1å¼€å§‹é€’å¢ï¼š\n" + "\n".join([f"{idx + 1}. {section}" for idx, section in enumerate(section_order)]) + "\n\næ³¨æ„ï¼šç« èŠ‚åœ¨JSONæ•°ç»„ä¸­çš„é¡ºåºå¿…é¡»ä¸ä¸Šè¿°é¡ºåºå®Œå…¨ä¸€è‡´ï¼Œchapter_numberå¿…é¡»ä»1å¼€å§‹è¿ç»­é€’å¢ã€‚"

format_requirements = "\n\n" + "\n".join(format_requirements_parts) + order_instruction + "\n\n**é‡è¦**ï¼šè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šæ ¼å¼è¦æ±‚ç”Ÿæˆå¤§çº²ï¼Œç¡®ä¿ï¼š\n1. ä¸€çº§æ ‡é¢˜ä½¿ç”¨æŒ‡å®šçš„æ ¼å¼ï¼ˆå¦‚ï¼šç¬¬ä¸€ç« ã€ç¬¬äºŒç« ï¼‰\n2. äºŒçº§æ ‡é¢˜ä½¿ç”¨æŒ‡å®šçš„æ ¼å¼ï¼ˆå¦‚ï¼š1.1ã€1.2ï¼‰\n3. ç‰¹æ®Šç« èŠ‚ï¼ˆæ‘˜è¦ã€ç»“è®ºã€å‚è€ƒæ–‡çŒ®ï¼‰ä¸ä½¿ç”¨ç« èŠ‚ç¼–å·\n4. ç« èŠ‚é¡ºåºå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ç« èŠ‚é¡ºåºè¦æ±‚\n5. ç« èŠ‚åœ¨chaptersæ•°ç»„ä¸­çš„é¡ºåºå¿…é¡»ä¸ç« èŠ‚é¡ºåºè¦æ±‚ä¸€è‡´\n6. chapter_numberå¿…é¡»ä»1å¼€å§‹è¿ç»­é€’å¢"
```

---

### âœ… 2. å¢å¼ºå¤§çº²è§£æå’ŒéªŒè¯

**æ–‡ä»¶**ï¼š`ai_generation_service.py`

**ä¿®æ”¹å†…å®¹**ï¼š
- åœ¨ `_validate_outline_format()` æ–¹æ³•ä¸­ï¼Œç¡®ä¿ç« èŠ‚æŒ‰ç…§ `chapter_number` æ’åº
- é‡æ–°è§„èŒƒåŒ– `chapter_number`ï¼Œç¡®ä¿ä»1å¼€å§‹è¿ç»­é€’å¢
- æ·»åŠ æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•

**å®ç°ä½ç½®**ï¼šç¬¬540-571è¡Œ

**å…³é”®ä»£ç **ï¼š
```python
# ç¡®ä¿ç« èŠ‚æŒ‰ç…§chapter_numberæ’åºï¼ˆä¸å¤§çº²é¡ºåºä¸€è‡´ï¼‰
validated_chapters = sorted(validated_chapters, key=lambda x: x.get('chapter_number', 999))

# é‡æ–°è§„èŒƒåŒ–chapter_numberï¼Œç¡®ä¿ä»1å¼€å§‹è¿ç»­é€’å¢
for idx, chapter in enumerate(validated_chapters):
    chapter['chapter_number'] = idx + 1
    logger.debug(f"è§„èŒƒåŒ–ç« èŠ‚é¡ºåºï¼šç´¢å¼•{idx} -> chapter_number={chapter['chapter_number']}, æ ‡é¢˜={chapter['chapter_title']}")

outline_data['chapters'] = validated_chapters
logger.info(f"å¤§çº²éªŒè¯å®Œæˆï¼Œå…± {len(validated_chapters)} ä¸ªç« èŠ‚ï¼Œé¡ºåºï¼š{[c['chapter_number'] for c in validated_chapters]}")
```

---

### âœ… 3. å¢å¼ºç« èŠ‚ç”Ÿæˆé¡ºåº

**æ–‡ä»¶**ï¼š`thesis_service.py`

**ä¿®æ”¹å†…å®¹**ï¼š
- åœ¨æ‰¹é‡ç”Ÿæˆç« èŠ‚æ—¶ï¼Œå…ˆå¯¹ `chapters_data` æŒ‰ç…§ `chapter_number` æ’åº
- ç¡®ä¿æŒ‰ç…§å¤§çº²é¡ºåºç”Ÿæˆç« èŠ‚
- æ·»åŠ æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•

**å®ç°ä½ç½®**ï¼šç¬¬521-526è¡Œ

**å…³é”®ä»£ç **ï¼š
```python
# æ‰¹é‡ç”Ÿæˆç« èŠ‚å†…å®¹ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ + æ–­ç‚¹ç»­ä¼ ï¼‰
# ç¡®ä¿æŒ‰ç…§chapter_numberé¡ºåºç”Ÿæˆï¼ˆä¸å¤§çº²é¡ºåºä¸€è‡´ï¼‰
chapters_data_sorted = sorted(chapters_data, key=lambda x: x.chapter_number if hasattr(x, 'chapter_number') and isinstance(x.chapter_number, int) else 999)
logger.info(f"ç« èŠ‚ç”Ÿæˆé¡ºåºï¼š{[c.chapter_number if hasattr(c, 'chapter_number') else 'N/A' for c in chapters_data_sorted]}")

generated_chapters = []
failed_chapters = []
skipped_chapters = []  # å·²å®Œæˆçš„ç« èŠ‚ï¼ˆè·³è¿‡ï¼‰

for chapter_data in chapters_data_sorted:
    # ... ç”Ÿæˆç« èŠ‚å†…å®¹
    chapter_dict_pre = {
        'thesis_id': thesis_id,
        'title': chapter_data.chapter_title,
        'level': 1,  # é»˜è®¤ä¸€çº§ç« èŠ‚
        'order_num': chapter_data.chapter_number if isinstance(chapter_data.chapter_number, int) else len(generated_chapters) + len(skipped_chapters) + 1,
        # ...
    }
```

---

### âœ… 4. æ ¼å¼åŒ–æ—¶ç¡®ä¿é¡ºåº

**æ–‡ä»¶**ï¼š`format_service.py`

**å·²æœ‰å®ç°**ï¼š
- æ ¼å¼åŒ–æ—¶å·²ç»æŒ‰ç…§ `order_num` æ’åº
- ç¡®ä¿ä¸å¤§çº²é¡ºåºä¸€è‡´

**å®ç°ä½ç½®**ï¼šç¬¬1769-1770è¡Œ

**å…³é”®ä»£ç **ï¼š
```python
# æŒ‰ç« èŠ‚é¡ºåºæ’åºï¼ˆç¡®ä¿ä¸å¤§çº²é¡ºåºä¸€è‡´ï¼‰
chapters = sorted(chapters, key=lambda x: getattr(x, 'order_num', 0) if hasattr(x, 'order_num') else 0)
logger.info(f"[æ­¥éª¤5/6] å¼€å§‹å¤„ç†ç« èŠ‚å†…å®¹ï¼Œå…± {len(chapters)} ä¸ªç« èŠ‚")
```

---

## ä¸‰ã€å·¥ä½œæµç¨‹

### 3.1 å®Œæ•´æµç¨‹

```
1. è¯»å–æ ¼å¼æŒ‡ä»¤ï¼ˆå¦‚æœæœ‰template_idï¼‰
   â†“
2. æå–section_orderï¼ˆç« èŠ‚ç»“æ„é¡ºåºï¼‰
   â†“
3. å¤§çº²ç”Ÿæˆï¼ˆAIæ ¹æ®section_orderç”Ÿæˆï¼Œchapter_numberä»1å¼€å§‹é€’å¢ï¼‰
   â†“
4. å¤§çº²è§£æå’ŒéªŒè¯ï¼ˆç¡®ä¿ç« èŠ‚æŒ‰chapter_numberæ’åºï¼Œé‡æ–°è§„èŒƒåŒ–ï¼‰
   â†“
5. ç« èŠ‚ç”Ÿæˆï¼ˆæŒ‰ç…§chapter_numberé¡ºåºç”Ÿæˆï¼Œorder_num = chapter_numberï¼‰
   â†“
6. æ ¼å¼åŒ–ï¼ˆæŒ‰ç…§order_numæ’åºï¼‰
```

### 3.2 é¡ºåºä¿è¯æœºåˆ¶

1. **å¤§çº²ç”Ÿæˆæ—¶**ï¼š
   - AIæ ¹æ® `section_order` ç”Ÿæˆç« èŠ‚
   - æ˜ç¡®è¦æ±‚ç« èŠ‚é¡ºåºå’Œ `chapter_number` é€’å¢

2. **å¤§çº²è§£ææ—¶**ï¼š
   - æŒ‰ç…§ `chapter_number` æ’åº
   - é‡æ–°è§„èŒƒåŒ– `chapter_number`ï¼Œç¡®ä¿ä»1å¼€å§‹è¿ç»­é€’å¢

3. **ç« èŠ‚ç”Ÿæˆæ—¶**ï¼š
   - æŒ‰ç…§ `chapter_number` æ’åºåç”Ÿæˆ
   - `order_num = chapter_number`

4. **æ ¼å¼åŒ–æ—¶**ï¼š
   - æŒ‰ç…§ `order_num` æ’åº

---

## å››ã€å…³é”®æ”¹è¿›ç‚¹

### âœ… 1. æ˜ç¡®é¡ºåºè¦æ±‚

- åœ¨æç¤ºè¯ä¸­æ˜ç¡®è¦æ±‚æŒ‰ç…§ `section_order` é¡ºåºç”Ÿæˆ
- æ˜ç¡®è¦æ±‚ `chapter_number` ä»1å¼€å§‹è¿ç»­é€’å¢
- æ˜ç¡®è¦æ±‚ç« èŠ‚åœ¨æ•°ç»„ä¸­çš„é¡ºåºå¿…é¡»ä¸€è‡´

### âœ… 2. è§„èŒƒåŒ–å¤„ç†

- å¤§çº²è§£ææ—¶ï¼Œé‡æ–°è§„èŒƒåŒ– `chapter_number`
- ç¡®ä¿ä»1å¼€å§‹è¿ç»­é€’å¢
- ç¡®ä¿ç« èŠ‚é¡ºåºæ­£ç¡®

### âœ… 3. æ’åºä¿è¯

- ç« èŠ‚ç”Ÿæˆå‰ï¼Œå…ˆå¯¹ç« èŠ‚æ•°æ®æ’åº
- æ ¼å¼åŒ–æ—¶ï¼ŒæŒ‰ç…§ `order_num` æ’åº
- ç¡®ä¿æ•´ä¸ªæµç¨‹ä¸­é¡ºåºä¸€è‡´

### âœ… 4. æ—¥å¿—è®°å½•

- è®°å½•ç« èŠ‚ç”Ÿæˆé¡ºåº
- è®°å½•å¤§çº²éªŒè¯ç»“æœ
- ä¾¿äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

---

## äº”ã€æµ‹è¯•å»ºè®®

### 5.1 æµ‹è¯•åœºæ™¯

1. **æœ‰section_orderçš„æƒ…å†µ**ï¼š
   - æµ‹è¯•å¤§çº²ç”Ÿæˆæ—¶æ˜¯å¦æŒ‰ç…§ `section_order` é¡ºåº
   - æµ‹è¯•ç« èŠ‚ç”Ÿæˆæ—¶æ˜¯å¦æŒ‰ç…§å¤§çº²é¡ºåº
   - æµ‹è¯•æ ¼å¼åŒ–æ—¶æ˜¯å¦æŒ‰ç…§æ­£ç¡®é¡ºåº

2. **æ— section_orderçš„æƒ…å†µ**ï¼š
   - æµ‹è¯•æ˜¯å¦ä½¿ç”¨é»˜è®¤é¡ºåº
   - æµ‹è¯•åŠŸèƒ½æ˜¯å¦æ­£å¸¸

3. **ç« èŠ‚é¡ºåºä¸ä¸€è‡´çš„æƒ…å†µ**ï¼š
   - æµ‹è¯•æ˜¯å¦èƒ½å¤Ÿè‡ªåŠ¨çº æ­£
   - æµ‹è¯•æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®æ’åº

### 5.2 æµ‹è¯•æ•°æ®

å»ºè®®ä½¿ç”¨å®é™…è®ºæ–‡æ•°æ®è¿›è¡Œæµ‹è¯•ï¼š
- åŒ…å«ä¸åŒ `section_order` çš„æ¨¡æ¿
- åŒ…å«ä¸åŒç« èŠ‚ç»“æ„çš„è®ºæ–‡
- åŒ…å«é¡ºåºä¸ä¸€è‡´çš„å¤§çº²

---

## å…­ã€æ€»ç»“

### âœ… å®ç°å®Œæˆ

1. âœ… **å¤§çº²ç”Ÿæˆæ—¶æ˜ç¡®é¡ºåºè¦æ±‚**ï¼šå·²å®ç°
2. âœ… **å¤§çº²è§£ææ—¶è§„èŒƒåŒ–é¡ºåº**ï¼šå·²å®ç°
3. âœ… **ç« èŠ‚ç”Ÿæˆæ—¶æŒ‰é¡ºåºç”Ÿæˆ**ï¼šå·²å®ç°
4. âœ… **æ ¼å¼åŒ–æ—¶æŒ‰é¡ºåºæ’åˆ—**ï¼šå·²å®ç°ï¼ˆå·²æœ‰ï¼‰

### ğŸ¯ æ ¸å¿ƒæ”¹è¿›

- **æ˜ç¡®è¦æ±‚**ï¼šåœ¨æç¤ºè¯ä¸­æ˜ç¡®è¦æ±‚æŒ‰ç…§ `section_order` é¡ºåºç”Ÿæˆ
- **è§„èŒƒåŒ–å¤„ç†**ï¼šç¡®ä¿ `chapter_number` ä»1å¼€å§‹è¿ç»­é€’å¢
- **æ’åºä¿è¯**ï¼šåœ¨æ•´ä¸ªæµç¨‹ä¸­ç¡®ä¿é¡ºåºä¸€è‡´
- **æ—¥å¿—è®°å½•**ï¼šä¾¿äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

**ç»“è®º**ï¼šâœ… **å¤§çº²ç”Ÿæˆå’Œç« èŠ‚å†…å®¹é¡ºåºå¯¹åº”å·²å®Œå…¨å®ç°ï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼**
