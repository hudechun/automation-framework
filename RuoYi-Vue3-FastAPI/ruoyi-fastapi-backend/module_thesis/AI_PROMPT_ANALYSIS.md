# AI提示词分析

## 一、提示词位置

**文件**：`format_service.py`  
**方法**：`_build_format_analysis_prompt()`  
**行数**：第764-1202行

---

## 二、提示词结构

### 2.1 核心原则部分

```
## ⚠️ 核心原则：
1. 严格按文档实际格式提取，不使用默认值或猜测
2. 原样返回：字体名称、字号、行距、缩进等必须与文档一致
```

**问题**：❌ 没有明确说明字体大小的单位是"磅"，也没有说明正常范围

---

### 2.2 文档格式信息部分

```
## 文档格式信息：
{content_json}
```

**说明**：这里传入的是从Word文档提取的格式信息（JSON格式）

**问题**：❌ 如果提取时使用了 `str(run.font.size)`，这里可能包含 `"Pt(457200)"` 或 `"457200"` 这样的EMU值

---

### 2.3 字体格式要求部分

```
### 1. 字体格式
- 默认字体、字号、颜色（从正文段落提取）
```

**问题**：❌ 没有明确说明：
- 字体大小的单位是"磅"（point）
- 正常范围是8-30磅
- 如果看到 `"Pt(457200)"` 格式，需要转换为磅值

---

### 2.4 标题格式要求部分

```
### 3. 标题格式（h1/h2/h3）
- 字体名称、字号、是否加粗、对齐方式、段前距、段后距
```

**问题**：❌ 没有明确说明：
- 字号的单位是"磅"
- 正常范围是8-30磅
- 如何正确提取和转换

---

### 2.5 JSON结构说明部分

在提示词中，JSON结构说明如下：

```json
"default_font": {
  "name": "默认中文字体（必须从文档中提取，如：宋体、楷体_GB2312）",
  "size_pt": 字体大小（数字，单位：磅，必须从文档中提取，如：12）,
  "color": "颜色（RGB值，如：000000表示黑色，必须从文档中提取）"
},
"headings": {
  "h1": {
    "font_name": "字体名称（必须从文档中提取，不要使用默认值）",
    "font_size_pt": 字体大小（数字，单位：磅，必须从文档中提取）,
    ...
  }
}
```

**说明**：✅ 这里明确说明了单位是"磅"，但**没有说明正常范围**

**问题**：❌ 没有说明：
- 正常范围是8-30磅
- 如果看到异常值（如45.72磅），需要重新检查
- 如果看到 `"Pt(457200)"` 格式，需要转换为磅值

---

## 三、完整提示词内容

### 3.1 开头部分

```
你是文档格式分析专家。分析Word文档格式并生成格式化指令。

## ⚠️ 核心原则：
1. 严格按文档实际格式提取，不使用默认值或猜测
2. 原样返回：字体名称、字号、行距、缩进等必须与文档一致

## 文档格式信息：
{content_json}  // 这里传入从Word文档提取的格式信息

## 任务：
生成两个输出：
1. **自然语言格式描述**：用自然语言描述格式要求（字体、字号、行距、页边距、标题格式等）
2. **JSON格式指令**：严格按照JSON结构返回格式化指令
```

---

### 3.2 格式提取要求部分

```
## 格式提取要求：

### 1. 字体格式
- 默认字体、字号、颜色（从正文段落提取）

### 2. 段落格式
- 对齐方式（left/center/right/justify）
- 行距倍数（如1.5）
- 段前距、段后距（磅）
- 首行缩进（磅，如24表示2字符）
- 左右缩进（磅）

### 3. 标题格式（h1/h2/h3）
- 字体名称、字号、是否加粗、对齐方式、段前距、段后距

### 4. 页面设置
- 页边距（磅，1英寸=72磅，1厘米=28.35磅）
- 纸张大小（A4/Letter等）
```

**问题**：❌ 虽然提到了"磅"作为单位，但没有明确说明：
- 字体大小的正常范围
- 如何识别异常值
- 如何转换EMU值

---

### 3.3 关键要求部分

```
## ⚠️ 关键要求（必须严格遵守）：

1. **必须从文档中实际提取所有格式信息，绝对不要使用默认值或猜测**
2. **如果文档中某个格式信息不存在，不要猜测，应该明确说明或使用文档中实际存在的值**
3. **字体名称必须准确**：如果文档中是"宋体"，就返回"宋体"；如果是"楷体_GB2312"，就返回"楷体_GB2312"，不要替换
4. **字体大小必须准确**：如果文档中是12磅，就返回12；如果是16磅，就返回16，不要使用"通常"的值
5. **行距必须准确**：如果文档中是1.5倍，就返回1.5；如果是1.0倍，就返回1.0，不要猜测
6. **首行缩进必须准确**：如果文档中是24磅，就返回24；如果是0，就返回0，不要猜测
7. **标题格式必须准确**：从文档中实际提取标题的字体、大小、是否加粗，不要使用"通常"的格式
```

**问题**：❌ 虽然要求"字体大小必须准确"，但没有说明：
- 如果看到 `"Pt(457200)"` 或 `"457200"` 这样的值，应该如何转换
- 如果提取的值是45.72磅，这是异常值，需要重新检查

---

### 3.4 格式提取示例部分

```
## 格式提取示例：

假设文档中提取到的格式信息显示：
- 正文段落字体：`font_name: "宋体"`, `font_size: "12"` → 返回 `"name": "宋体", "size": 12`
- 正文段落行距：`line_spacing: "1.5"` → 返回 `"line_spacing": 1.5`
- 正文首行缩进：`first_line_indent: "24"` → 返回 `"first_line_indent": 24`
- 一级标题字体：`font_name: "黑体"`, `font_size: "15"`, `bold: true` → 返回 `"font_name": "黑体", "font_size": 15, "bold": true`

**不要这样做**：
- ❌ 文档中是"楷体_GB2312"，但返回"宋体"（因为"通常"用宋体）
- ❌ 文档中是16磅，但返回12磅（因为"通常"是12磅）
- ❌ 文档中是1.0倍行距，但返回1.5倍（因为"通常"是1.5倍）
- ❌ 文档中没有首行缩进（0），但返回24磅（因为"通常"需要首行缩进）
```

**问题**：❌ 示例中假设 `font_size: "12"` 是字符串，但没有说明：
- 如果看到 `"Pt(457200)"` 或 `"457200"` 这样的值，应该如何转换
- 如果提取的值是45.72磅，这是异常值，需要重新检查

---

## 四、问题总结

### ❌ 问题1：没有明确说明字体大小的单位转换

**当前提示词**：
- 只说了"单位：磅"
- 但没有说明如果看到 `"Pt(457200)"` 或 `"457200"` 这样的值，应该如何转换

**应该补充**：
```
### 字体大小提取要求：
- **单位**：必须使用"磅"（point）作为单位
- **正常范围**：8-30磅（正文通常12磅，标题通常14-18磅）
- **提取方式**：
  - 如果文档中字体大小是数字（如 `12`），直接使用
  - 如果文档中字体大小是 `"Pt(457200)"` 格式，这是EMU值，需要转换为磅值：457200 / 12700 ≈ 36磅
  - 如果文档中字体大小是 `"457200"` 格式，这是EMU值，需要转换为磅值：457200 / 12700 ≈ 36磅
- **验证**：提取后必须验证是否在合理范围内（8-30磅），如果不在范围内，需要重新检查
```

---

### ❌ 问题2：没有明确说明正常范围

**当前提示词**：
- 只说了"必须从文档中实际提取"
- 但没有说明正常范围是8-30磅

**应该补充**：
```
- **正常范围**：8-30磅
  - 正文：通常12磅（小四号）
  - 一级标题：通常14-18磅
  - 二级标题：通常12-14磅
  - 三级标题：通常10-12磅
- **异常值识别**：如果提取的值不在正常范围内（如45.72磅），需要重新检查
```

---

### ❌ 问题3：没有说明如何识别异常值

**当前提示词**：
- 只说了"必须准确"
- 但没有说明如何识别异常值

**应该补充**：
```
- **异常值识别**：
  - 如果提取的字体大小小于8磅或大于30磅，这是异常值
  - 如果所有字体大小都是同一个异常值（如45.72磅），说明提取方式可能有问题
  - 需要重新检查提取方式，确保使用正确的单位转换
```

---

## 五、改进建议

### ✅ 建议1：在"字体格式"部分添加明确说明

```
### 1. 字体格式
- 默认字体、字号、颜色（从正文段落提取）
- **重要**：字体大小单位是"磅"（point），正常范围是8-30磅
  - 正文通常12磅（小四号）
  - 标题通常14-18磅
- **重要**：如果文档中字体大小是 `"Pt(457200)"` 或 `"457200"` 格式，这是EMU值，需要转换为磅值：EMU值 / 12700
- **重要**：如果提取的值不在正常范围内（如45.72磅），需要重新检查
```

---

### ✅ 建议2：在"关键要求"部分添加验证要求

```
## ⚠️ 关键要求（必须严格遵守）：

...

8. **字体大小验证**：
   - 提取后必须验证是否在合理范围内（8-30磅）
   - 如果不在范围内，需要重新检查提取方式
   - 如果所有字体大小都是同一个异常值（如45.72磅），说明提取方式可能有问题
```

---

### ✅ 建议3：在"格式提取示例"部分添加异常值示例

```
## 格式提取示例：

...

**异常值处理**：
- ❌ 如果看到 `font_size: "Pt(457200)"` 或 `"457200"`，不要直接使用，需要转换为磅值：457200 / 12700 ≈ 36磅
- ❌ 如果提取的值是45.72磅，这是异常值，需要重新检查
- ✅ 正确的做法：如果文档中字体大小是12磅，返回12；如果是16磅，返回16
```

---

## 六、结论

**当前提示词的问题**：
1. ❌ 没有明确说明字体大小的单位转换（EMU值如何转换为磅值）
2. ❌ 没有明确说明正常范围（8-30磅）
3. ❌ 没有说明如何识别异常值

**改进方向**：
1. ✅ 在"字体格式"部分添加明确说明
2. ✅ 在"关键要求"部分添加验证要求
3. ✅ 在"格式提取示例"部分添加异常值示例

**根本问题**：
- 提示词虽然要求"必须准确"，但AI看到的是错误的格式信息（EMU值）
- AI不知道如何转换，导致误识别
- 需要在提示词中明确说明如何转换和验证
