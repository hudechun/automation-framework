# 章节生成与格式化流程规范

## 一、章节生成流程

### 1.1 数据来源

章节生成需要以下信息：

1. **论文基本信息**：
   - 论文标题
   - 专业
   - 学历（从模板表获取）
   - 关键词

2. **章节信息**（从大纲中提取）：
   - `chapter_number`：章节编号（整数，如：1, 2, 3）
   - `chapter_title`：章节标题（字符串）
   - `sections`：小节数组（可选，但推荐）

3. **小节信息**（从大纲中提取）：
   - `section_number`：小节编号（字符串，如："1.1", "1.2"）
   - `section_title`：小节标题（字符串）
   - `content_outline`：小节内容概要（字符串）

4. **大纲上下文**（完整的大纲结构）：
   - 帮助AI理解论文整体结构和章节关系

5. **字数要求**：
   - 根据目标总字数和章节数量计算
   - 格式：`"最小值-最大值"`（如："2000-3000"）

### 1.2 章节生成提示词结构

```
## 论文基本信息：
- 论文标题
- 专业
- 学位级别（从模板获取）
- 关键词

## 章节信息：
第X章 章节标题

## 小节结构（如果有）：
### 1.1 小节标题
内容概要：...

### 1.2 小节标题
内容概要：...

## 论文大纲上下文：
（完整的大纲JSON结构）

## 写作要求：
1. 学术规范性
2. 内容质量（字数要求）
3. 结构要求
4. 格式要求（Markdown格式）
5. 内容相关性

## 输出要求：
- 格式要求（Markdown规范）
- 内容结构要求
- 示例格式
```

### 1.3 章节内容格式要求

#### 必须使用Markdown格式

1. **二级标题**：`## 标题`
   - 用于小节标题（对应大纲中的sections）
   - 格式：`## 小节编号 小节标题`
   - 示例：`## 1.1 研究背景与意义`

2. **三级标题**：`### 标题`
   - 用于更细的层次划分

3. **加粗文本**：`**文本**`
   - 用于重要概念或关键词

4. **段落**：段落之间用空行分隔

5. **列表**：可以使用 `-` 或 `1.` 表示列表项

#### 内容结构

```
章节引言（1-2段，介绍本章主要内容）

## 1.1 小节标题（如果有小节结构）
（小节内容，多段文字）

## 1.2 小节标题
（小节内容，多段文字）

章节小结（1段，适当的小结或过渡）
```

#### 禁止内容

- ❌ 不要包含"章节内容："等说明文字
- ❌ 不要包含章节标题（系统自动添加）
- ❌ 不要包含章节编号（如"第1章"、"第一章"）

## 二、格式化流程

### 2.1 数据来源

格式化时直接从数据库读取：

1. **章节列表**：`ai_write_thesis_chapter` 表
   - 只处理 `status='completed'` 的章节
   - 按 `order_num` 排序

2. **格式配置**：从模板的 `format_data` 获取
   - 字体配置
   - 段落配置
   - 标题配置
   - 页面配置

3. **论文信息**：用于文档头部（标题等）

### 2.2 格式化流程

```
1. 获取所有已完成的章节（按order_num排序）
   ↓
2. 创建新Word文档
   ↓
3. 应用页面设置（页边距、纸张大小）
   ↓
4. 添加论文标题（如果有）
   ↓
5. 遍历章节：
   a. 添加章节标题（应用标题格式）
   b. 解析章节内容（Markdown格式）
   c. 应用格式：
      - 二级标题（##）→ Word标题样式
      - 三级标题（###）→ Word标题样式
      - 加粗文本（**文本**）→ 粗体格式
      - 普通段落 → 正文格式（首行缩进、行距等）
   d. 章节之间添加分页符（可选）
   ↓
6. 保存Word文档
```

### 2.3 Markdown解析规则

**位置**：`format_service.py:_create_formatted_document()`

#### 支持的Markdown格式

1. **二级标题**（`## 标题`）：
   - 转换为Word段落
   - 字体大小：14磅
   - 加粗：是
   - 对齐：左对齐
   - 段前距：12磅
   - 段后距：6磅

2. **三级标题**（`### 标题`）：
   - 转换为Word段落
   - 字体大小：13磅
   - 加粗：是
   - 对齐：左对齐
   - 段前距：10磅
   - 段后距：4磅

3. **加粗文本**（`**文本**`）：
   - 在段落中识别 `**文本**` 模式
   - 应用粗体格式

4. **普通段落**：
   - 应用正文格式
   - 首行缩进（从格式配置获取）
   - 行距（从格式配置获取）
   - 对齐方式（从格式配置获取）

5. **空行**：
   - 转换为空段落

## 三、衔接机制

### 3.1 大纲 → 章节生成

**数据传递**：
1. 从大纲中提取章节信息（`chapter_number`, `chapter_title`, `sections`）
2. 传递给 `generate_chapter()` 方法
3. 在提示词中包含小节结构，指导AI生成内容

**格式对应**：
- 大纲中的 `sections` → 章节内容中的 `## 小节标题`
- 大纲中的 `section_title` → Markdown二级标题
- 大纲中的 `content_outline` → 小节内容概要（在提示词中）

### 3.2 章节生成 → 格式化

**数据存储**：
- 章节内容以Markdown格式存储在 `ai_write_thesis_chapter.content` 字段
- 章节标题存储在 `ai_write_thesis_chapter.title` 字段
- 章节顺序存储在 `ai_write_thesis_chapter.order_num` 字段

**格式解析**：
- 格式化时读取 `content` 字段
- 解析Markdown格式（`##`, `###`, `**文本**`）
- 转换为Word格式

**顺序保证**：
- 按 `order_num` 排序，确保章节顺序正确
- 章节标题从 `title` 字段获取，与大纲中的 `chapter_title` 对应

### 3.3 格式一致性

**章节标题**：
- 生成时：不包含在章节内容中
- 格式化时：从 `title` 字段单独添加，应用标题格式

**小节标题**：
- 生成时：使用 `## 小节编号 小节标题` 格式
- 格式化时：解析 `##` 标记，转换为Word标题样式

**内容结构**：
- 生成时：按照大纲中的小节结构组织
- 格式化时：保持Markdown结构，转换为Word格式

## 四、关键代码位置

1. **章节生成提示词**：`ai_generation_service.py:_build_chapter_prompt()` (第548行)
2. **章节生成**：`ai_generation_service.py:generate_chapter()` (第497行)
3. **格式化文档**：`format_service.py:_create_formatted_document()` (第470行)
4. **Markdown解析**：`format_service.py:_create_formatted_document()` (第573-661行)

## 五、格式要求总结

### 5.1 章节内容格式（AI生成）

- ✅ 使用Markdown格式
- ✅ 二级标题：`## 小节编号 小节标题`
- ✅ 三级标题：`### 标题`
- ✅ 加粗文本：`**文本**`
- ✅ 段落之间用空行分隔
- ❌ 不包含章节标题
- ❌ 不包含说明文字

### 5.2 格式化处理

- ✅ 解析Markdown格式
- ✅ 转换为Word格式
- ✅ 应用格式配置
- ✅ 保持内容结构
- ✅ 按章节顺序排列

## 六、测试建议

1. **测试小节结构**：验证小节标题是否正确转换为Word格式
2. **测试Markdown格式**：验证 `##`, `###`, `**文本**` 是否正确解析
3. **测试章节顺序**：验证 `order_num` 排序是否正确
4. **测试格式应用**：验证字体、段落、标题格式是否正确应用
