# ç«¯åˆ°ç«¯åŠ¨æ€æ ¼å¼åŒ–æ–¹æ¡ˆ

## ä¸€ã€æ ¸å¿ƒæ€æƒ³

**"ä¸€æ¬¡æ€§ç”Ÿæˆå‡†ç¡®çš„æŒ‡ä»¤ã€å¤§çº²å’Œç« èŠ‚å†…å®¹ï¼Œæ ¼å¼åŒ–æ—¶ç›´æ¥åº”ç”¨ï¼Œæ— éœ€è½¬æ¢"**

### 1.1 å½“å‰é—®é¢˜

**å¤šæ­¥éª¤ã€å¤šéªŒè¯çš„é—®é¢˜**ï¼š
1. âŒ æŒ‡ä»¤æå–å¯èƒ½ä¸å‡†ç¡®ï¼ˆå­—ä½“å¤§å°å¼‚å¸¸ï¼‰
2. âŒ å¤§çº²ç”Ÿæˆå¯èƒ½ä¸ç¬¦åˆæ ¼å¼ï¼ˆç« èŠ‚æ ‡é¢˜æ ¼å¼ï¼‰
3. âŒ ç« èŠ‚ç”Ÿæˆå¯èƒ½ä¸ç¬¦åˆæ ¼å¼
4. âŒ æ ¼å¼åŒ–æ—¶éœ€è¦è½¬æ¢å’Œçº æ­£

**ç»“æœ**ï¼šéœ€è¦å¤šæ¬¡éªŒè¯å’Œçº æ­£ï¼Œå®¹æ˜“å‡ºé”™

---

### 1.2 ç›®æ ‡æ–¹æ¡ˆ

**ç«¯åˆ°ç«¯ã€ä¸€æ¬¡ç”Ÿæˆã€ç›´æ¥åº”ç”¨**ï¼š
1. âœ… ä»æ ¼å¼æ¨¡æ¿æå–å‡†ç¡®çš„æŒ‡ä»¤ï¼ˆå¸¦éªŒè¯ï¼‰
2. âœ… æ ¹æ®æŒ‡ä»¤ç”Ÿæˆç¬¦åˆæ ¼å¼çš„å¤§çº²ï¼ˆä¸¥æ ¼çº¦æŸï¼‰
3. âœ… æ ¹æ®æŒ‡ä»¤ç”Ÿæˆç¬¦åˆæ ¼å¼çš„ç« èŠ‚å†…å®¹ï¼ˆä¸¥æ ¼çº¦æŸï¼‰
4. âœ… æ ¼å¼åŒ–æ—¶ç›´æ¥åº”ç”¨ï¼Œæ— éœ€è½¬æ¢

**ç»“æœ**ï¼šä¸€æ¬¡æ€§ç”Ÿæˆå‡†ç¡®ï¼Œæ ¼å¼åŒ–æ—¶ç›´æ¥åº”ç”¨

---

## äºŒã€è®¾è®¡æ–¹æ¡ˆ

### 2.1 æ–¹æ¡ˆæ¶æ„

```
æ ¼å¼æ¨¡æ¿ä¸Šä¼ 
    â†“
[æ­¥éª¤1] AIæå–æ ¼å¼æŒ‡ä»¤ï¼ˆå¸¦ä¸¥æ ¼éªŒè¯ï¼‰
    â†“
[æ­¥éª¤2] éªŒè¯å’Œä¿®æ­£æŒ‡ä»¤ï¼ˆè‡ªåŠ¨ä¿®æ­£å¼‚å¸¸å€¼ï¼‰
    â†“
[æ­¥éª¤3] ä¿å­˜å‡†ç¡®çš„æŒ‡ä»¤åˆ°æ•°æ®åº“
    â†“
[æ­¥éª¤4] æ ¹æ®æŒ‡ä»¤ç”Ÿæˆå¤§çº²ï¼ˆä¸¥æ ¼éµå¾ªæ ¼å¼è¦æ±‚ï¼‰
    â†“
[æ­¥éª¤5] æ ¹æ®æŒ‡ä»¤ç”Ÿæˆç« èŠ‚å†…å®¹ï¼ˆä¸¥æ ¼éµå¾ªæ ¼å¼è¦æ±‚ï¼‰
    â†“
[æ­¥éª¤6] æ ¼å¼åŒ–æ—¶ç›´æ¥åº”ç”¨æŒ‡ä»¤ï¼ˆæ— éœ€è½¬æ¢ï¼‰
```

---

### 2.2 å…³é”®æ”¹è¿›ç‚¹

#### æ”¹è¿›1ï¼šæŒ‡ä»¤æå–æ—¶ä¸¥æ ¼éªŒè¯

**å½“å‰é—®é¢˜**ï¼š
- AIæå–çš„æŒ‡ä»¤å¯èƒ½ä¸å‡†ç¡®ï¼ˆå¦‚å­—ä½“å¤§å°45.72ç£…ï¼‰

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- æå–åç«‹å³éªŒè¯
- è‡ªåŠ¨ä¿®æ­£å¼‚å¸¸å€¼
- ç¡®ä¿æŒ‡ä»¤å‡†ç¡®

**å®ç°**ï¼š
```python
async def extract_format_instructions(template_file):
    # 1. AIæå–æ ¼å¼æŒ‡ä»¤
    raw_instructions = await ai_extract_format(template_file)
    
    # 2. ç«‹å³éªŒè¯å’Œä¿®æ­£
    validated_instructions = validate_and_fix_instructions(raw_instructions)
    
    # 3. è¿”å›å‡†ç¡®çš„æŒ‡ä»¤
    return validated_instructions
```

---

#### æ”¹è¿›2ï¼šå¤§çº²ç”Ÿæˆæ—¶ä¸¥æ ¼çº¦æŸ

**å½“å‰é—®é¢˜**ï¼š
- AIç”Ÿæˆçš„å¤§çº²å¯èƒ½ä¸ç¬¦åˆæ ¼å¼è¦æ±‚

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- åœ¨æç¤ºè¯ä¸­æä¾›å®Œæ•´çš„æ ¼å¼ç¤ºä¾‹
- ä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºï¼ˆJSON Schemaï¼‰
- ç”Ÿæˆåç«‹å³éªŒè¯å’Œçº æ­£

**å®ç°**ï¼š
```python
async def generate_outline(thesis_info, format_instructions):
    # 1. ä»æŒ‡ä»¤ä¸­æå–æ ¼å¼è¦æ±‚
    format_constraints = extract_format_constraints(format_instructions)
    
    # 2. æ„å»ºä¸¥æ ¼çº¦æŸçš„æç¤ºè¯
    prompt = build_strict_prompt(thesis_info, format_constraints)
    
    # 3. AIç”Ÿæˆå¤§çº²ï¼ˆå¸¦JSON Schemaçº¦æŸï¼‰
    outline = await ai_generate_with_schema(prompt, outline_schema)
    
    # 4. ç«‹å³éªŒè¯å’Œçº æ­£
    validated_outline = validate_and_fix_outline(outline, format_instructions)
    
    return validated_outline
```

---

#### æ”¹è¿›3ï¼šç« èŠ‚ç”Ÿæˆæ—¶ä¸¥æ ¼çº¦æŸ

**å½“å‰é—®é¢˜**ï¼š
- AIç”Ÿæˆçš„ç« èŠ‚å†…å®¹å¯èƒ½ä¸ç¬¦åˆæ ¼å¼è¦æ±‚

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- åœ¨æç¤ºè¯ä¸­æ˜ç¡®æ ¼å¼è¦æ±‚
- æä¾›æ ¼å¼ç¤ºä¾‹
- ç”ŸæˆåéªŒè¯æ ¼å¼

**å®ç°**ï¼š
```python
async def generate_chapter(chapter_info, format_instructions):
    # 1. ä»æŒ‡ä»¤ä¸­æå–ç« èŠ‚æ ¼å¼è¦æ±‚
    chapter_format = extract_chapter_format(format_instructions, chapter_info)
    
    # 2. æ„å»ºä¸¥æ ¼çº¦æŸçš„æç¤ºè¯
    prompt = build_strict_chapter_prompt(chapter_info, chapter_format)
    
    # 3. AIç”Ÿæˆç« èŠ‚å†…å®¹ï¼ˆå¸¦æ ¼å¼çº¦æŸï¼‰
    content = await ai_generate_with_format(prompt, chapter_format)
    
    return content
```

---

#### æ”¹è¿›4ï¼šæ ¼å¼åŒ–æ—¶ç›´æ¥åº”ç”¨

**å½“å‰é—®é¢˜**ï¼š
- æ ¼å¼åŒ–æ—¶éœ€è¦è½¬æ¢å’Œçº æ­£

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- å› ä¸ºå†…å®¹å·²ç»ç¬¦åˆæ ¼å¼è¦æ±‚ï¼Œç›´æ¥åº”ç”¨å³å¯
- ä¸éœ€è¦è½¬æ¢é€»è¾‘

**å®ç°**ï¼š
```python
async def format_thesis(chapters, format_instructions):
    # ç›´æ¥åº”ç”¨æ ¼å¼ï¼ˆå†…å®¹å·²ç»ç¬¦åˆè¦æ±‚ï¼‰
    formatted_doc = apply_format(chapters, format_instructions)
    return formatted_doc
```

---

## ä¸‰ã€å…·ä½“å®ç°æ–¹æ¡ˆ

### 3.1 æŒ‡ä»¤æå–å¢å¼ºï¼šä¸¥æ ¼éªŒè¯

**æ–‡ä»¶**ï¼š`format_service.py` çš„ `read_word_document_with_ai()` æ–¹æ³•

**æ”¹è¿›**ï¼š
```python
async def read_word_document_with_ai(template_file):
    # 1. AIæå–æ ¼å¼æŒ‡ä»¤
    raw_instructions = await ai_extract_format(template_file)
    
    # 2. ç«‹å³éªŒè¯å’Œä¿®æ­£
    validated_instructions = validate_and_fix_format_instructions(raw_instructions)
    
    # 3. è¿”å›å‡†ç¡®çš„æŒ‡ä»¤
    return validated_instructions

def validate_and_fix_format_instructions(instructions):
    """éªŒè¯å’Œä¿®æ­£æ ¼å¼æŒ‡ä»¤"""
    # æ£€æŸ¥å­—ä½“å¤§å°
    if 'format_rules' in instructions:
        format_rules = instructions['format_rules']
        
        # æ£€æŸ¥é»˜è®¤å­—ä½“å¤§å°
        if 'default_font' in format_rules:
            size = format_rules['default_font'].get('size_pt', 12)
            if size < 8 or size > 30:
                logger.warning(f"å­—ä½“å¤§å°å¼‚å¸¸: {size}ç£…ï¼Œä¿®æ­£ä¸º12ç£…")
                format_rules['default_font']['size_pt'] = 12
        
        # æ£€æŸ¥æ ‡é¢˜å­—ä½“å¤§å°
        if 'headings' in format_rules:
            for level in ['h1', 'h2', 'h3']:
                if level in format_rules['headings']:
                    size = format_rules['headings'][level].get('font_size_pt', 14)
                    if size < 8 or size > 30:
                        default_size = 14 if level == 'h1' else 12
                        logger.warning(f"{level}æ ‡é¢˜å­—ä½“å¤§å°å¼‚å¸¸: {size}ç£…ï¼Œä¿®æ­£ä¸º{default_size}ç£…")
                        format_rules['headings'][level]['font_size_pt'] = default_size
    
    return instructions
```

---

### 3.2 å¤§çº²ç”Ÿæˆå¢å¼ºï¼šJSON Schemaçº¦æŸ

**æ–‡ä»¶**ï¼š`ai_generation_service.py` çš„ `generate_outline()` æ–¹æ³•

**æ”¹è¿›**ï¼š
```python
async def generate_outline(thesis_info, template_id, format_instructions):
    # 1. ä»æ ¼å¼æŒ‡ä»¤ä¸­æå–çº¦æŸ
    constraints = extract_outline_constraints(format_instructions)
    
    # 2. æ„å»ºJSON Schema
    outline_schema = build_outline_schema(constraints)
    
    # 3. AIç”Ÿæˆå¤§çº²ï¼ˆå¸¦Schemaçº¦æŸï¼‰
    outline = await ai_generate_with_schema(
        prompt=build_outline_prompt(thesis_info, constraints),
        schema=outline_schema
    )
    
    # 4. éªŒè¯å’Œçº æ­£
    validated_outline = validate_and_fix_outline(outline, constraints)
    
    return validated_outline

def build_outline_schema(constraints):
    """æ„å»ºå¤§çº²JSON Schema"""
    chapter_numbering = constraints.get('chapter_numbering_format', {})
    level_1 = chapter_numbering.get('level_1', {})
    pattern = level_1.get('pattern', 'ç¬¬{number}ç«  {title}')
    
    return {
        "type": "object",
        "properties": {
            "title": {"type": "string"},
            "chapters": {
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "chapter_number": {
                            "oneOf": [
                                {"type": "null"},
                                {"type": "integer", "minimum": 1}
                            ]
                        },
                        "chapter_title": {
                            "type": "string",
                            "pattern": f"^{pattern.replace('{number}', '\\\\d+').replace('{title}', '.+')}$"  # éªŒè¯æ ‡é¢˜æ ¼å¼
                        },
                        "sections": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "section_number": {"type": "string"},
                                    "section_title": {"type": "string"},
                                    "content_outline": {"type": "string"}
                                }
                            }
                        }
                    },
                    "required": ["chapter_title"]
                }
            }
        }
    }
```

---

### 3.3 ç« èŠ‚ç”Ÿæˆå¢å¼ºï¼šæ ¼å¼æ¨¡æ¿çº¦æŸ

**æ–‡ä»¶**ï¼š`ai_generation_service.py` çš„ `generate_chapter()` æ–¹æ³•

**æ”¹è¿›**ï¼š
```python
async def generate_chapter(chapter_info, format_instructions):
    # 1. ä»æ ¼å¼æŒ‡ä»¤ä¸­æå–ç« èŠ‚æ ¼å¼
    chapter_format = extract_chapter_format(format_instructions, chapter_info)
    
    # 2. æ„å»ºæ ¼å¼æ¨¡æ¿
    format_template = build_format_template(chapter_format)
    
    # 3. AIç”Ÿæˆç« èŠ‚å†…å®¹ï¼ˆå¸¦æ ¼å¼æ¨¡æ¿ï¼‰
    content = await ai_generate_with_template(
        prompt=build_chapter_prompt(chapter_info, chapter_format),
        format_template=format_template
    )
    
    return content

def build_format_template(chapter_format):
    """æ„å»ºæ ¼å¼æ¨¡æ¿"""
    return f"""
## æ ¼å¼è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š

### æ ‡é¢˜æ ¼å¼
- å­—ä½“ï¼š{chapter_format['heading']['font_name']}
- å­—å·ï¼š{chapter_format['heading']['font_size_pt']}ç£…
- å¯¹é½ï¼š{chapter_format['heading']['alignment']}
- åŠ ç²—ï¼š{'æ˜¯' if chapter_format['heading']['bold'] else 'å¦'}

### æ®µè½æ ¼å¼
- å­—ä½“ï¼š{chapter_format['paragraph']['font_name']}
- å­—å·ï¼š{chapter_format['paragraph']['font_size_pt']}ç£…
- è¡Œè·ï¼š{chapter_format['paragraph']['line_spacing']}å€
- é¦–è¡Œç¼©è¿›ï¼š{chapter_format['paragraph']['first_line_indent_chars']}å­—ç¬¦

**é‡è¦**ï¼šç”Ÿæˆçš„å†…å®¹å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šæ ¼å¼è¦æ±‚ã€‚
"""
```

---

### 3.4 æ ¼å¼åŒ–ç®€åŒ–ï¼šç›´æ¥åº”ç”¨

**æ–‡ä»¶**ï¼š`format_service.py` çš„ `format_thesis()` æ–¹æ³•

**æ”¹è¿›**ï¼š
```python
async def format_thesis(thesis_id, format_instructions):
    # 1. è·å–ç« èŠ‚ï¼ˆå·²ç»ç¬¦åˆæ ¼å¼è¦æ±‚ï¼‰
    chapters = await get_chapters(thesis_id)
    
    # 2. ç›´æ¥åº”ç”¨æ ¼å¼ï¼ˆæ— éœ€è½¬æ¢ï¼‰
    formatted_doc = apply_format(chapters, format_instructions)
    
    return formatted_doc
```

---

## å››ã€åŠ¨æ€è°ƒæ•´æœºåˆ¶

### 4.1 æŒ‡ä»¤éªŒè¯å’Œä¿®æ­£

**æœºåˆ¶**ï¼š
- æå–åç«‹å³éªŒè¯
- è‡ªåŠ¨ä¿®æ­£å¼‚å¸¸å€¼
- ç¡®ä¿æŒ‡ä»¤å‡†ç¡®

**å®ç°**ï¼š
```python
def validate_and_fix_format_instructions(instructions):
    """åŠ¨æ€éªŒè¯å’Œä¿®æ­£æ ¼å¼æŒ‡ä»¤"""
    fixes = []
    
    # éªŒè¯å­—ä½“å¤§å°
    if 'format_rules' in instructions:
        format_rules = instructions['format_rules']
        
        # æ£€æŸ¥æ‰€æœ‰å­—ä½“å¤§å°
        font_sizes = [
            ('default_font', 'size_pt'),
            ('headings.h1', 'font_size_pt'),
            ('headings.h2', 'font_size_pt'),
            ('headings.h3', 'font_size_pt'),
        ]
        
        for path, key in font_sizes:
            size = get_nested_value(format_rules, path, key)
            if size and (size < 8 or size > 30):
                # ä¿®æ­£ä¸ºåˆç†å€¼
                fixed_size = 12 if 'default' in path else 14
                set_nested_value(format_rules, path, key, fixed_size)
                fixes.append(f"{path}.{key}: {size}ç£… -> {fixed_size}ç£…")
    
    if fixes:
        logger.info(f"æ ¼å¼æŒ‡ä»¤å·²ä¿®æ­£: {', '.join(fixes)}")
    
    return instructions
```

---

### 4.2 å¤§çº²éªŒè¯å’Œçº æ­£

**æœºåˆ¶**ï¼š
- ç”Ÿæˆåç«‹å³éªŒè¯
- è‡ªåŠ¨çº æ­£æ ¼å¼é—®é¢˜
- ç¡®ä¿å¤§çº²ç¬¦åˆè¦æ±‚

**å®ç°**ï¼š
```python
def validate_and_fix_outline(outline, format_instructions):
    """åŠ¨æ€éªŒè¯å’Œçº æ­£å¤§çº²"""
    # 1. éªŒè¯ç« èŠ‚æ ‡é¢˜æ ¼å¼
    chapter_numbering = format_instructions.get('application_rules', {}).get('chapter_numbering_format', {})
    level_1 = chapter_numbering.get('level_1', {})
    
    if level_1:
        pattern = level_1.get('pattern', 'ç¬¬{number}ç«  {title}')
        number_style = level_1.get('number_style', 'chinese')
        
        for chapter in outline.get('chapters', []):
            if chapter.get('chapter_number'):
                # æ£€æŸ¥å¹¶çº æ­£æ ‡é¢˜æ ¼å¼
                if not matches_pattern(chapter['chapter_title'], pattern):
                    chapter['chapter_title'] = format_title(chapter['chapter_title'], chapter['chapter_number'], pattern, number_style)
    
    # 2. éªŒè¯ç‰¹æ®Šç« èŠ‚
    special_sections = format_instructions.get('application_rules', {}).get('special_section_format_rules', {})
    for chapter in outline.get('chapters', []):
        chapter_title = chapter.get('chapter_title', '')
        for section_type, section_config in special_sections.items():
            if section_config.get('title') in chapter_title:
                if not section_config.get('should_have_numbering', False):
                    chapter['chapter_number'] = None
    
    return outline
```

---

### 4.3 ç« èŠ‚å†…å®¹éªŒè¯

**æœºåˆ¶**ï¼š
- ç”ŸæˆåéªŒè¯æ ¼å¼
- ç¡®ä¿ç¬¦åˆè¦æ±‚

**å®ç°**ï¼š
```python
def validate_chapter_content(content, format_instructions):
    """éªŒè¯ç« èŠ‚å†…å®¹æ ¼å¼"""
    # æ£€æŸ¥æ ‡é¢˜æ ¼å¼
    # æ£€æŸ¥æ®µè½æ ¼å¼
    # æ£€æŸ¥æ ‡ç‚¹ç¬¦å·
    # ...
    return content
```

---

## äº”ã€ä¸€æ¬¡æ€§ç”Ÿæˆæµç¨‹

### 5.1 å®Œæ•´æµç¨‹

```
1. ä¸Šä¼ æ ¼å¼æ¨¡æ¿
   â†“
2. AIæå–æ ¼å¼æŒ‡ä»¤ + ç«‹å³éªŒè¯ä¿®æ­£
   â†“ ä¿å­˜å‡†ç¡®çš„æŒ‡ä»¤
3. ç”¨æˆ·åˆ›å»ºè®ºæ–‡
   â†“
4. æ ¹æ®æŒ‡ä»¤ç”Ÿæˆå¤§çº² + ç«‹å³éªŒè¯çº æ­£
   â†“ ä¿å­˜ç¬¦åˆæ ¼å¼çš„å¤§çº²
5. æ ¹æ®æŒ‡ä»¤å’Œå¤§çº²ç”Ÿæˆç« èŠ‚å†…å®¹ + ç«‹å³éªŒè¯
   â†“ ä¿å­˜ç¬¦åˆæ ¼å¼çš„ç« èŠ‚å†…å®¹
6. æ ¼å¼åŒ–æ—¶ç›´æ¥åº”ç”¨æŒ‡ä»¤
   â†“ ç”Ÿæˆæœ€ç»ˆæ–‡æ¡£
```

---

### 5.2 å…³é”®ä¿è¯

1. **æŒ‡ä»¤å‡†ç¡®æ€§**ï¼š
   - æå–åç«‹å³éªŒè¯
   - è‡ªåŠ¨ä¿®æ­£å¼‚å¸¸å€¼
   - ç¡®ä¿æŒ‡ä»¤å‡†ç¡®

2. **å¤§çº²å‡†ç¡®æ€§**ï¼š
   - ç”Ÿæˆæ—¶ä¸¥æ ¼çº¦æŸ
   - ç”Ÿæˆåç«‹å³éªŒè¯
   - è‡ªåŠ¨çº æ­£æ ¼å¼é—®é¢˜

3. **ç« èŠ‚å‡†ç¡®æ€§**ï¼š
   - ç”Ÿæˆæ—¶ä¸¥æ ¼çº¦æŸ
   - ç”Ÿæˆåç«‹å³éªŒè¯
   - ç¡®ä¿æ ¼å¼æ­£ç¡®

4. **æ ¼å¼åŒ–ç®€åŒ–**ï¼š
   - ç›´æ¥åº”ç”¨æ ¼å¼
   - æ— éœ€è½¬æ¢
   - ç¡®ä¿æ­£ç¡®

---

## å…­ã€å®ç°å»ºè®®

### 6.1 æŒ‡ä»¤æå–å¢å¼º

**ä¿®æ”¹ä½ç½®**ï¼š`template_service.py` çš„ `create_template()` æ–¹æ³•

**å®ç°**ï¼š
```python
async def create_template(template_data):
    # 1. AIæå–æ ¼å¼æŒ‡ä»¤
    format_instructions = await read_word_document_with_ai(template_file)
    
    # 2. ç«‹å³éªŒè¯å’Œä¿®æ­£
    validated_instructions = validate_and_fix_format_instructions(format_instructions)
    
    # 3. ä¿å­˜å‡†ç¡®çš„æŒ‡ä»¤
    template.format_data = validated_instructions
    await save_template(template)
```

---

### 6.2 å¤§çº²ç”Ÿæˆå¢å¼º

**ä¿®æ”¹ä½ç½®**ï¼š`ai_generation_service.py` çš„ `generate_outline()` æ–¹æ³•

**å®ç°**ï¼š
```python
async def generate_outline(thesis_info, template_id):
    # 1. è¯»å–æ ¼å¼æŒ‡ä»¤
    format_instructions = await get_format_instructions(template_id)
    
    # 2. æå–æ ¼å¼çº¦æŸ
    constraints = extract_outline_constraints(format_instructions)
    
    # 3. ç”Ÿæˆå¤§çº²ï¼ˆå¸¦ä¸¥æ ¼çº¦æŸï¼‰
    outline = await ai_generate_with_constraints(thesis_info, constraints)
    
    # 4. éªŒè¯å’Œçº æ­£
    validated_outline = validate_and_fix_outline(outline, format_instructions)
    
    return validated_outline
```

---

### 6.3 ç« èŠ‚ç”Ÿæˆå¢å¼º

**ä¿®æ”¹ä½ç½®**ï¼š`ai_generation_service.py` çš„ `generate_chapter()` æ–¹æ³•

**å®ç°**ï¼š
```python
async def generate_chapter(chapter_info, format_instructions):
    # 1. æå–ç« èŠ‚æ ¼å¼
    chapter_format = extract_chapter_format(format_instructions, chapter_info)
    
    # 2. ç”Ÿæˆç« èŠ‚å†…å®¹ï¼ˆå¸¦æ ¼å¼çº¦æŸï¼‰
    content = await ai_generate_with_format(chapter_info, chapter_format)
    
    # 3. éªŒè¯æ ¼å¼
    validated_content = validate_chapter_content(content, chapter_format)
    
    return validated_content
```

---

## ä¸ƒã€ä¼˜åŠ¿

### âœ… 1. ä¸€æ¬¡æ€§å‡†ç¡®

- æŒ‡ä»¤æå–åç«‹å³éªŒè¯ä¿®æ­£
- å¤§çº²ç”Ÿæˆåç«‹å³éªŒè¯çº æ­£
- ç« èŠ‚ç”Ÿæˆåç«‹å³éªŒè¯
- ç¡®ä¿æ¯ä¸€æ­¥éƒ½å‡†ç¡®

### âœ… 2. åŠ¨æ€è°ƒæ•´

- è‡ªåŠ¨æ£€æµ‹å¼‚å¸¸å€¼
- è‡ªåŠ¨ä¿®æ­£é”™è¯¯
- é€‚åº”å„ç§æ ¼å¼

### âœ… 3. æ ¼å¼åŒ–ç®€åŒ–

- ç›´æ¥åº”ç”¨æ ¼å¼
- æ— éœ€è½¬æ¢
- ç¡®ä¿æ­£ç¡®

### âœ… 4. å®Œå…¨é€šç”¨

- é€‚åº”æ‰€æœ‰å­¦æ ¡æ ¼å¼
- ä¸ä¾èµ–ç¡¬ç¼–ç 
- åŠ¨æ€è°ƒæ•´

---

## å…«ã€æ€»ç»“

### ğŸ¯ æ ¸å¿ƒæ€æƒ³

**"ç«¯åˆ°ç«¯ã€ä¸€æ¬¡ç”Ÿæˆã€ç›´æ¥åº”ç”¨ã€åŠ¨æ€è°ƒæ•´"**

### âœ… å®ç°è¦ç‚¹

1. **æŒ‡ä»¤æå–**ï¼šæå–åç«‹å³éªŒè¯ä¿®æ­£
2. **å¤§çº²ç”Ÿæˆ**ï¼šç”Ÿæˆæ—¶ä¸¥æ ¼çº¦æŸï¼Œç”ŸæˆåéªŒè¯çº æ­£
3. **ç« èŠ‚ç”Ÿæˆ**ï¼šç”Ÿæˆæ—¶ä¸¥æ ¼çº¦æŸï¼Œç”ŸæˆåéªŒè¯
4. **æ ¼å¼åŒ–**ï¼šç›´æ¥åº”ç”¨ï¼Œæ— éœ€è½¬æ¢

### ğŸ“ ä¼˜åŠ¿

- âœ… ä¸€æ¬¡æ€§å‡†ç¡®
- âœ… åŠ¨æ€è°ƒæ•´
- âœ… æ ¼å¼åŒ–ç®€åŒ–
- âœ… å®Œå…¨é€šç”¨

**ç»“è®º**ï¼šâœ… **ç«¯åˆ°ç«¯åŠ¨æ€æ ¼å¼åŒ–æ–¹æ¡ˆå¯ä»¥å®ç°ä¸€æ¬¡æ€§ç”Ÿæˆå‡†ç¡®çš„æŒ‡ä»¤ã€å¤§çº²å’Œç« èŠ‚å†…å®¹ï¼Œæ ¼å¼åŒ–æ—¶ç›´æ¥åº”ç”¨ï¼Œé€‚åº”æ‰€æœ‰æ ¼å¼ï¼**
