# æŒ‡ä»¤ç³»ç»Ÿå¦‚ä½•è¿ç”¨åˆ°å¤§çº²å’Œç« èŠ‚å†…å®¹

## ä¸€ã€æ ¸å¿ƒæ€æƒ³

**"æŒ‡ä»¤ç³»ç»Ÿæè¿°æ ¼å¼è¦æ±‚ï¼ŒAIåœ¨ç”Ÿæˆæ—¶å°±éµå¾ªæ ¼å¼è¦æ±‚ï¼Œæ ¼å¼åŒ–æ—¶åªåº”ç”¨æ ¼å¼"**

### 1.1 æ”¹è¿›å‰çš„é—®é¢˜

**å½“å‰æµç¨‹**ï¼š
```
å¤§çº²ç”Ÿæˆï¼ˆæ ¼å¼å¯èƒ½ä¸å¯¹ï¼‰ â†’ ç« èŠ‚ç”Ÿæˆï¼ˆæ ¼å¼å¯èƒ½ä¸å¯¹ï¼‰ â†’ æ ¼å¼åŒ–ï¼ˆè½¬æ¢æ ¼å¼ï¼‰ â†’ åº”ç”¨æ ¼å¼
```

**é—®é¢˜**ï¼š
- âŒ å¤§çº²å’Œç« èŠ‚ç”Ÿæˆæ—¶æ²¡æœ‰ä½¿ç”¨æ ¼å¼æŒ‡ä»¤
- âŒ ä¾èµ–ç¡¬ç¼–ç çš„è½¬æ¢é€»è¾‘
- âŒ ä¸åŒå­¦æ ¡éœ€è¦ä¸åŒçš„è½¬æ¢é€»è¾‘

### 1.2 æ”¹è¿›åçš„æ–¹æ¡ˆ

**æ”¹è¿›æµç¨‹**ï¼š
```
è¯»å–æ ¼å¼æŒ‡ä»¤ â†’ å¤§çº²ç”Ÿæˆï¼ˆæ ¹æ®æŒ‡ä»¤ï¼‰ â†’ ç« èŠ‚ç”Ÿæˆï¼ˆæ ¹æ®æŒ‡ä»¤ï¼‰ â†’ æ ¼å¼åŒ–ï¼ˆåªåº”ç”¨æ ¼å¼ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¤§çº²å’Œç« èŠ‚ç”Ÿæˆæ—¶ä½¿ç”¨æ ¼å¼æŒ‡ä»¤
- âœ… ä¸ä¾èµ–ç¡¬ç¼–ç çš„è½¬æ¢é€»è¾‘
- âœ… é€‚åº”æ‰€æœ‰å­¦æ ¡çš„æ ¼å¼è¦æ±‚

---

## äºŒã€æŒ‡ä»¤ç³»ç»Ÿå¦‚ä½•è¿ç”¨åˆ°å¤§çº²ç”Ÿæˆ

### 2.1 å½“å‰å®ç°

**ä½ç½®**ï¼š`ai_generation_service.py` çš„ `generate_outline()` æ–¹æ³•

**å½“å‰é—®é¢˜**ï¼š
- æ²¡æœ‰ä½¿ç”¨æ ¼å¼æŒ‡ä»¤
- AIç”Ÿæˆçš„å¤§çº²æ ¼å¼å¯èƒ½ä¸ç¬¦åˆè¦æ±‚

### 2.2 æ”¹è¿›æ–¹æ¡ˆ

**ä¿®æ”¹ä½ç½®**ï¼š`ai_generation_service.py` çš„ `generate_outline()` æ–¹æ³•

**å®ç°ä»£ç **ï¼š
```python
async def generate_outline(thesis_info, template_id=None):
    # 1. å¦‚æœæœ‰æ¨¡æ¿IDï¼Œè¯»å–æ ¼å¼æŒ‡ä»¤
    format_requirements = ""
    if template_id:
        template = await get_template(template_id)
        format_instructions = json.loads(template.format_data)
        
        # æå–æ ¼å¼è¦æ±‚
        application_rules = format_instructions.get('application_rules', {})
        chapter_numbering = application_rules.get('chapter_numbering_format', {})
        document_structure = application_rules.get('document_structure', {})
        special_sections = application_rules.get('special_section_format_rules', {})
        
        # æ„å»ºæ ¼å¼è¦æ±‚æç¤ºè¯
        format_requirements = f"""
        
        **æ ¼å¼è¦æ±‚**ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
        
        1. **ç« èŠ‚ç¼–å·æ ¼å¼**ï¼š
           - ä¸€çº§æ ‡é¢˜ï¼š{chapter_numbering.get('level_1', {}).get('pattern', 'ç¬¬Xç«  æ ‡é¢˜')}
             ç¤ºä¾‹ï¼š{', '.join(chapter_numbering.get('level_1', {}).get('examples', ['ç¬¬ä¸€ç«  å¼•è¨€']))}
           - äºŒçº§æ ‡é¢˜ï¼š{chapter_numbering.get('level_2', {}).get('pattern', 'X.Y æ ‡é¢˜')}
             ç¤ºä¾‹ï¼š{', '.join(chapter_numbering.get('level_2', {}).get('examples', ['1.1 ç ”ç©¶èƒŒæ™¯']))}
        
        2. **ç« èŠ‚ç»“æ„é¡ºåº**ï¼š
           {', '.join(document_structure.get('section_order', []))}
        
        3. **ç‰¹æ®Šç« èŠ‚æ ¼å¼**ï¼š
           - æ‘˜è¦ï¼š{special_sections.get('abstract', {}).get('title', 'æ‘˜è¦')}ï¼ˆæ— ç¼–å·ï¼‰
           - å…³é”®è¯ï¼š{special_sections.get('keywords', {}).get('title', 'å…³é”®è¯')}ï¼ˆæ— ç¼–å·ï¼‰
           - ç»“è®ºï¼š{special_sections.get('conclusion', {}).get('title', 'ç»“è®º')}ï¼ˆæ— ç¼–å·ï¼‰
           - å‚è€ƒæ–‡çŒ®ï¼š{special_sections.get('references', {}).get('title', 'å‚è€ƒæ–‡çŒ®')}ï¼ˆæ— ç¼–å·ï¼‰
        
        **é‡è¦**ï¼šè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šæ ¼å¼è¦æ±‚ç”Ÿæˆå¤§çº²ï¼Œç¡®ä¿ï¼š
        1. ä¸€çº§æ ‡é¢˜ä½¿ç”¨æŒ‡å®šçš„æ ¼å¼ï¼ˆå¦‚ï¼šç¬¬ä¸€ç« ã€ç¬¬äºŒç« ï¼‰
        2. äºŒçº§æ ‡é¢˜ä½¿ç”¨æŒ‡å®šçš„æ ¼å¼ï¼ˆå¦‚ï¼š1.1ã€1.2ï¼‰
        3. ç‰¹æ®Šç« èŠ‚ï¼ˆæ‘˜è¦ã€ç»“è®ºã€å‚è€ƒæ–‡çŒ®ï¼‰ä¸ä½¿ç”¨ç« èŠ‚ç¼–å·
        4. ç« èŠ‚é¡ºåºç¬¦åˆè¦æ±‚
        """
    
    # 2. æ„å»ºæç¤ºè¯ï¼ˆåŒ…å«æ ¼å¼è¦æ±‚ï¼‰
    prompt = build_outline_prompt(thesis_info, format_requirements)
    
    # 3. AIç”Ÿæˆç¬¦åˆæ ¼å¼è¦æ±‚çš„å¤§çº²
    outline = await ai.generate(prompt)
    
    return outline
```

### 2.3 æ•ˆæœ

**æ”¹è¿›å‰**ï¼š
```
AIç”Ÿæˆçš„å¤§çº²ï¼š
1. 1.1 ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰
2. 2.1 äººå·¥æ™ºèƒ½çš„å®šä¹‰
...
7. 7.1 ç»“è®º
8. 8.1 å‚è€ƒæ–‡çŒ®
```

**æ”¹è¿›å**ï¼š
```
AIç”Ÿæˆçš„å¤§çº²ï¼ˆå·²ç»ç¬¦åˆæ ¼å¼è¦æ±‚ï¼‰ï¼š
1. æ‘˜è¦ï¼ˆæ— ç¼–å·ï¼‰
2. å…³é”®è¯ï¼ˆæ— ç¼–å·ï¼‰
3. ç¬¬ä¸€ç«  ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰
4. ç¬¬äºŒç«  äººå·¥æ™ºèƒ½çš„å®šä¹‰
...
6. ç»“è¯­ï¼ˆæ— ç¼–å·ï¼‰
7. å‚è€ƒæ–‡çŒ®ï¼ˆæ— ç¼–å·ï¼‰
```

---

## ä¸‰ã€æŒ‡ä»¤ç³»ç»Ÿå¦‚ä½•è¿ç”¨åˆ°ç« èŠ‚ç”Ÿæˆ

### 3.1 å½“å‰å®ç°

**ä½ç½®**ï¼š`ai_generation_service.py` çš„ `generate_chapter()` æ–¹æ³•

**å½“å‰é—®é¢˜**ï¼š
- æ²¡æœ‰ä½¿ç”¨æ ¼å¼æŒ‡ä»¤
- AIç”Ÿæˆçš„ç« èŠ‚å†…å®¹æ ¼å¼å¯èƒ½ä¸ç¬¦åˆè¦æ±‚

### 3.2 æ”¹è¿›æ–¹æ¡ˆ

**ä¿®æ”¹ä½ç½®**ï¼š`ai_generation_service.py` çš„ `generate_chapter()` æ–¹æ³•

**å®ç°ä»£ç **ï¼š
```python
async def generate_chapter(chapter_info, template_id=None):
    # 1. å¦‚æœæœ‰æ¨¡æ¿IDï¼Œè¯»å–æ ¼å¼æŒ‡ä»¤
    format_requirements = ""
    if template_id:
        template = await get_template(template_id)
        format_instructions = json.loads(template.format_data)
        
        # æå–ç« èŠ‚æ ¼å¼è¦æ±‚
        chapter_level = chapter_info.get('level', 1)
        heading_config = format_instructions.get('headings', {}).get(f'h{chapter_level}', {})
        paragraph_config = format_instructions.get('paragraph', {})
        default_font = format_instructions.get('default_font', {})
        
        # æ„å»ºæ ¼å¼è¦æ±‚æç¤ºè¯
        format_requirements = f"""
        
        **æ ¼å¼è¦æ±‚**ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
        
        1. **æ ‡é¢˜æ ¼å¼**ï¼š
           - å­—ä½“ï¼š{heading_config.get('font_name', 'é»‘ä½“')}
           - å­—å·ï¼š{heading_config.get('font_size_pt', 14)}ç£…
           - å¯¹é½ï¼š{heading_config.get('alignment', 'left')}
           - åŠ ç²—ï¼š{heading_config.get('bold', True)}
        
        2. **æ®µè½æ ¼å¼**ï¼š
           - å­—ä½“ï¼š{default_font.get('name', 'å®‹ä½“')}
           - å­—å·ï¼š{default_font.get('size_pt', 12)}ç£…
           - è¡Œè·ï¼š{paragraph_config.get('line_spacing', 1.5)}å€
           - é¦–è¡Œç¼©è¿›ï¼š{paragraph_config.get('first_line_indent_chars', 0)}å­—ç¬¦
           - å¯¹é½ï¼š{paragraph_config.get('alignment', 'justify')}
        
        3. **æ ‡ç‚¹ç¬¦å·**ï¼š
           - ä¸­æ–‡éƒ¨åˆ†ä½¿ç”¨å…¨è§’æ ‡ç‚¹
           - è‹±æ–‡éƒ¨åˆ†ä½¿ç”¨åŠè§’æ ‡ç‚¹
        
        **é‡è¦**ï¼šè¯·ç¡®ä¿ç”Ÿæˆçš„å†…å®¹ç¬¦åˆä»¥ä¸Šæ ¼å¼è¦æ±‚ã€‚
        """
    
    # 2. æ„å»ºæç¤ºè¯ï¼ˆåŒ…å«æ ¼å¼è¦æ±‚ï¼‰
    prompt = build_chapter_prompt(chapter_info, format_requirements)
    
    # 3. AIç”Ÿæˆç¬¦åˆæ ¼å¼è¦æ±‚çš„ç« èŠ‚å†…å®¹
    chapter_content = await ai.generate(prompt)
    
    return chapter_content
```

### 3.3 æ•ˆæœ

**æ”¹è¿›å‰**ï¼š
```
AIç”Ÿæˆçš„ç« èŠ‚å†…å®¹ï¼š
- æ ‡é¢˜æ ¼å¼å¯èƒ½ä¸å¯¹
- æ®µè½æ ¼å¼å¯èƒ½ä¸å¯¹
- éœ€è¦åç»­è½¬æ¢
```

**æ”¹è¿›å**ï¼š
```
AIç”Ÿæˆçš„ç« èŠ‚å†…å®¹ï¼ˆå·²ç»ç¬¦åˆæ ¼å¼è¦æ±‚ï¼‰ï¼š
- æ ‡é¢˜æ ¼å¼æ­£ç¡®ï¼ˆå­—ä½“ã€å­—å·ã€å¯¹é½ï¼‰
- æ®µè½æ ¼å¼æ­£ç¡®ï¼ˆè¡Œè·ã€ç¼©è¿›ã€å¯¹é½ï¼‰
- ä¸éœ€è¦åç»­è½¬æ¢
```

---

## å››ã€æ ¼å¼åŒ–é˜¶æ®µï¼šåªåº”ç”¨æ ¼å¼

### 4.1 æ”¹è¿›å‰

```python
# 1. è·å–ç« èŠ‚
chapters = get_chapters()

# 2. è½¬æ¢æ ¼å¼ï¼ˆç¡¬ç¼–ç ï¼‰
chapters = convert_chapter_numbering(chapters)  # 1.1 â†’ ç¬¬ä¸€ç« 

# 3. åº”ç”¨æ ¼å¼
apply_format(chapters, format_instructions)
```

### 4.2 æ”¹è¿›å

```python
# 1. è·å–ç« èŠ‚ï¼ˆå·²ç»ç¬¦åˆæ ¼å¼è¦æ±‚ï¼Œå› ä¸ºç”Ÿæˆæ—¶ä½¿ç”¨äº†æŒ‡ä»¤ï¼‰
chapters = get_chapters()

# 2. ç›´æ¥åº”ç”¨æ ¼å¼ï¼ˆä¸éœ€è¦è½¬æ¢ï¼‰
apply_format(chapters, format_instructions)
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸éœ€è¦è½¬æ¢é€»è¾‘
- âœ… å‡å°‘æ ¼å¼é”™è¯¯
- âœ… æé«˜å‡†ç¡®æ€§

---

## äº”ã€æŒ‡ä»¤ç³»ç»Ÿè®¾è®¡æ”¹è¿›

### 5.1 ä»è½¬æ¢è§„åˆ™æ”¹ä¸ºæ ¼å¼æè¿°è§„åˆ™

**æ”¹è¿›å‰**ï¼ˆè½¬æ¢è§„åˆ™ï¼‰ï¼š
```json
{
  "chapter_numbering_conversion": {
    "enabled": true,
    "source_format": "X.Y",
    "target_format": "ç¬¬Xç« ",
    "conversion_pattern": "^\\d+\\.\\d+\\s+(.+)$"
  }
}
```

**æ”¹è¿›å**ï¼ˆæ ¼å¼æè¿°è§„åˆ™ï¼‰ï¼š
```json
{
  "chapter_numbering_format": {
    "level_1": {
      "format_type": "chinese_chapter",
      "pattern": "ç¬¬{number}ç«  {title}",
      "number_style": "chinese",
      "examples": ["ç¬¬ä¸€ç«  å¼•è¨€", "ç¬¬äºŒç«  ç ”ç©¶èƒŒæ™¯"]
    },
    "level_2": {
      "format_type": "numbered",
      "pattern": "{parent}.{number} {title}",
      "number_style": "arabic",
      "examples": ["1.1 ç ”ç©¶èƒŒæ™¯", "1.2 ç ”ç©¶æ„ä¹‰"]
    }
  },
  "special_section_format_rules": {
    "conclusion": {
      "title": "ç»“è¯­",
      "should_have_numbering": false,
      "position": "before_references"
    }
  }
}
```

### 5.2 ä¼˜åŠ¿

1. **æè¿°æ€§**ï¼šæè¿°æ ¼å¼è¦æ±‚ï¼Œè€Œä¸æ˜¯è½¬æ¢è§„åˆ™
2. **é€šç”¨æ€§**ï¼šé€‚åº”æ‰€æœ‰å­¦æ ¡çš„æ ¼å¼è¦æ±‚
3. **å¯ç»´æŠ¤æ€§**ï¼šä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œåªéœ€è¦æ›´æ–°æ ¼å¼æŒ‡ä»¤

---

## å…­ã€å®ç°å»ºè®®

### 6.1 ä¿®æ”¹å¤§çº²ç”Ÿæˆæ–¹æ³•

**æ–‡ä»¶**ï¼š`ai_generation_service.py`

**æ–¹æ³•**ï¼š`generate_outline()`

**ä¿®æ”¹**ï¼š
1. æ·»åŠ  `template_id` å‚æ•°
2. å¦‚æœæœ‰ `template_id`ï¼Œè¯»å–æ ¼å¼æŒ‡ä»¤
3. æå–æ ¼å¼è¦æ±‚ï¼Œæ„å»ºæç¤ºè¯
4. AIç”Ÿæˆç¬¦åˆæ ¼å¼è¦æ±‚çš„å¤§çº²

### 6.2 ä¿®æ”¹ç« èŠ‚ç”Ÿæˆæ–¹æ³•

**æ–‡ä»¶**ï¼š`ai_generation_service.py`

**æ–¹æ³•**ï¼š`generate_chapter()`

**ä¿®æ”¹**ï¼š
1. æ·»åŠ  `template_id` å‚æ•°
2. å¦‚æœæœ‰ `template_id`ï¼Œè¯»å–æ ¼å¼æŒ‡ä»¤
3. æå–æ ¼å¼è¦æ±‚ï¼Œæ„å»ºæç¤ºè¯
4. AIç”Ÿæˆç¬¦åˆæ ¼å¼è¦æ±‚çš„ç« èŠ‚å†…å®¹

### 6.3 ä¿®æ”¹æ ¼å¼åŒ–æ–¹æ³•

**æ–‡ä»¶**ï¼š`format_service.py`

**æ–¹æ³•**ï¼š`format_thesis()`

**ä¿®æ”¹**ï¼š
1. ç§»é™¤è½¬æ¢é€»è¾‘ï¼ˆ`chapter_numbering_conversion`ã€`abstract_extraction`ï¼‰
2. ç›´æ¥åº”ç”¨æ ¼å¼ï¼ˆå› ä¸ºå†…å®¹å·²ç»ç¬¦åˆæ ¼å¼è¦æ±‚ï¼‰

---

## ä¸ƒã€æ€»ç»“

### âœ… æ ¸å¿ƒæ”¹è¿›

1. **æŒ‡ä»¤ç³»ç»Ÿä»è½¬æ¢è§„åˆ™æ”¹ä¸ºæ ¼å¼æè¿°è§„åˆ™**
2. **å¤§çº²ç”Ÿæˆæ—¶ä½¿ç”¨æŒ‡ä»¤ç³»ç»Ÿ**
3. **ç« èŠ‚ç”Ÿæˆæ—¶ä½¿ç”¨æŒ‡ä»¤ç³»ç»Ÿ**
4. **æ ¼å¼åŒ–æ—¶åªåº”ç”¨æ ¼å¼ï¼Œä¸è½¬æ¢æ ¼å¼**

### ğŸ¯ è®¾è®¡åŸåˆ™

- **æè¿°æ€§**ï¼šæŒ‡ä»¤ç³»ç»Ÿæè¿°æ ¼å¼è¦æ±‚ï¼Œè€Œä¸æ˜¯è½¬æ¢è§„åˆ™
- **ä¸»åŠ¨æ€§**ï¼šæŒ‡ä»¤ç³»ç»Ÿä¸»åŠ¨å‚ä¸æ•´ä¸ªæµç¨‹ï¼ˆå¤§çº²ã€ç« èŠ‚ã€æ ¼å¼åŒ–ï¼‰
- **é€šç”¨æ€§**ï¼šä¸ä¾èµ–ç¡¬ç¼–ç ï¼Œé€‚åº”æ‰€æœ‰å­¦æ ¡çš„è¦æ±‚

### ğŸ“ ä¼˜åŠ¿

1. âœ… **å®Œå…¨é€šç”¨**ï¼šé€‚åº”æ‰€æœ‰å­¦æ ¡çš„æ ¼å¼è¦æ±‚
2. âœ… **å‡†ç¡®æ€§æé«˜**ï¼šAIåœ¨ç”Ÿæˆæ—¶å°±ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼
3. âœ… **å¯ç»´æŠ¤æ€§æé«˜**ï¼šä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œåªéœ€è¦æ›´æ–°æ ¼å¼æŒ‡ä»¤
4. âœ… **æŒ‡ä»¤ç³»ç»Ÿå……åˆ†è¿ç”¨**ï¼šåœ¨æ•´ä¸ªæµç¨‹ä¸­éƒ½ä½¿ç”¨æŒ‡ä»¤ç³»ç»Ÿ

**ç»“è®º**ï¼šâœ… **æ”¹è¿›åçš„æŒ‡ä»¤ç³»ç»Ÿæ›´åŠ é€šç”¨ã€å¯é ï¼Œå¯ä»¥é€‚åº”æ‰€æœ‰å­¦æ ¡çš„æ ¼å¼è¦æ±‚ï¼**
