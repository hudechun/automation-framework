# JWT å¯†é’¥ä½œç”¨è¯¦è§£

## ðŸ“– é€šä¿—è§£é‡Š

### æ¯”å–»ï¼šé“¶è¡Œæ”¯ç¥¨

JWT å¯†é’¥å°±åƒé“¶è¡Œçš„**é˜²ä¼ªå°ç« **ï¼š

1. **ç­¾å‘æ”¯ç¥¨ï¼ˆç™»å½•ï¼‰**
   - ä½ åŽ»é“¶è¡Œï¼ˆç™»å½•ç³»ç»Ÿï¼‰
   - é“¶è¡Œç»™ä½ ä¸€å¼ æ”¯ç¥¨ï¼ˆJWT Tokenï¼‰
   - æ”¯ç¥¨ä¸Šç›–äº†é“¶è¡Œçš„å°ç« ï¼ˆç”¨å¯†é’¥ç­¾åï¼‰

2. **ä½¿ç”¨æ”¯ç¥¨ï¼ˆè®¿é—®æŽ¥å£ï¼‰**
   - ä½ æ‹¿æ”¯ç¥¨åŽ»å•†åº—ï¼ˆè®¿é—® APIï¼‰
   - å•†åº—éªŒè¯å°ç« ï¼ˆç”¨å¯†é’¥éªŒè¯ç­¾åï¼‰
   - å°ç« çœŸå®žï¼Œäº¤æ˜“æˆåŠŸ

3. **ä¼ªé€ æ”¯ç¥¨ï¼ˆæ”»å‡»ï¼‰**
   - å¦‚æžœæœ‰äººçŸ¥é“å°ç« çš„åˆ¶ä½œæ–¹æ³•ï¼ˆå¯†é’¥æ³„éœ²ï¼‰
   - ä»–å¯ä»¥ä¼ªé€ ä»»ä½•é‡‘é¢çš„æ”¯ç¥¨ï¼ˆä¼ªé€  tokenï¼‰
   - å•†åº—æ— æ³•åˆ†è¾¨çœŸå‡ï¼ˆç³»ç»Ÿè¢«æ”»ç ´ï¼‰

---

## ðŸ”„ å®Œæ•´çš„ç™»å½•æµç¨‹

### 1. ç”¨æˆ·ç™»å½•

```
ç”¨æˆ·                    åŽç«¯æœåŠ¡å™¨                  æ•°æ®åº“
 |                          |                          |
 |-- ç”¨æˆ·å: admin -------->|                          |
 |    å¯†ç : admin123        |                          |
 |                          |-- æŸ¥è¯¢ç”¨æˆ· ------------->|
 |                          |<-- è¿”å›žç”¨æˆ·ä¿¡æ¯ ---------|
 |                          |                          |
 |                          | [éªŒè¯å¯†ç ]               |
 |                          | [ç”Ÿæˆ Token]             |
 |                          |   user_info = {          |
 |                          |     user_id: 1,          |
 |                          |     username: "admin"    |
 |                          |   }                      |
 |                          |   token = jwt.encode(    |
 |                          |     user_info,           |
 |                          |     JWT_SECRET_KEY âœ¨    |
 |                          |   )                      |
 |                          |                          |
 |<-- è¿”å›ž Token -----------|                          |
 |    "eyJhbGci..."         |                          |
```

### 2. è®¿é—®å—ä¿æŠ¤çš„æŽ¥å£

```
ç”¨æˆ·                    åŽç«¯æœåŠ¡å™¨                  Redis
 |                          |                          |
 |-- èŽ·å–ç”¨æˆ·åˆ—è¡¨ --------->|                          |
 |    Header:               |                          |
 |    Authorization:        |                          |
 |    Bearer eyJhbGci...    |                          |
 |                          | [éªŒè¯ Token]             |
 |                          |   jwt.decode(            |
 |                          |     token,               |
 |                          |     JWT_SECRET_KEY âœ¨    |
 |                          |   )                      |
 |                          |                          |
 |                          |-- æ£€æŸ¥ Token æ˜¯å¦æœ‰æ•ˆ -->|
 |                          |<-- Token æœ‰æ•ˆ -----------|
 |                          |                          |
 |                          | [æ‰§è¡Œä¸šåŠ¡é€»è¾‘]           |
 |                          |                          |
 |<-- è¿”å›žç”¨æˆ·åˆ—è¡¨ ---------|                          |
```

---

## ðŸ” å¯†é’¥çš„ä¸‰å¤§ä½œç”¨

### 1. é˜²æ­¢ä¼ªé€ ï¼ˆå®Œæ•´æ€§ï¼‰

**æ²¡æœ‰å¯†é’¥çš„æƒ…å†µ**:
```python
# Token å†…å®¹ï¼ˆBase64 ç¼–ç ï¼Œä»»ä½•äººéƒ½èƒ½è§£ç ï¼‰
{
  "user_id": 100,
  "username": "normal_user"
}

# æ”»å‡»è€…ä¿®æ”¹ä¸º
{
  "user_id": 1,
  "username": "admin"  # æ”¹æˆç®¡ç†å‘˜
}

# ç³»ç»Ÿæ— æ³•æ£€æµ‹åˆ°ç¯¡æ”¹ âŒ
```

**æœ‰å¯†é’¥çš„æƒ…å†µ**:
```python
# Token = å†…å®¹ + ç­¾å
{
  "user_id": 100,
  "username": "normal_user"
}
+ 
ç­¾å: HMAC-SHA256(å†…å®¹, JWT_SECRET_KEY)

# æ”»å‡»è€…ä¿®æ”¹å†…å®¹åŽ
# ç­¾åä¸åŒ¹é…ï¼ŒéªŒè¯å¤±è´¥ âœ…
```

### 2. èº«ä»½è®¤è¯ï¼ˆçœŸå®žæ€§ï¼‰

```python
# åªæœ‰æ‹¥æœ‰æ­£ç¡®å¯†é’¥çš„æœåŠ¡å™¨æ‰èƒ½ç”Ÿæˆæœ‰æ•ˆ token
def login(username, password):
    if verify_password(username, password):
        token = jwt.encode(
            {"user_id": user.id},
            JWT_SECRET_KEY  # åªæœ‰æœåŠ¡å™¨çŸ¥é“
        )
        return token
    
# å®¢æˆ·ç«¯æ— æ³•è‡ªå·±ç”Ÿæˆæœ‰æ•ˆ token
# å› ä¸ºä¸çŸ¥é“ JWT_SECRET_KEY
```

### 3. çŽ¯å¢ƒéš”ç¦»ï¼ˆå®‰å…¨æ€§ï¼‰

```python
# å¼€å‘çŽ¯å¢ƒ
DEV_SECRET = "dev_key_123"
dev_token = jwt.encode({"user_id": 1}, DEV_SECRET)

# ç”Ÿäº§çŽ¯å¢ƒ
PROD_SECRET = "prod_key_456"  # ä¸åŒçš„å¯†é’¥

# å¼€å‘çŽ¯å¢ƒçš„ token åœ¨ç”Ÿäº§çŽ¯å¢ƒæ— æ•ˆ
jwt.decode(dev_token, PROD_SECRET)  # âŒ ç­¾åéªŒè¯å¤±è´¥
```

---

## âš ï¸ å¯†é’¥æ³„éœ²çš„å±å®³

### åœºæ™¯ 1: æ”»å‡»è€…èŽ·å–å¯†é’¥

```python
# æ”»å‡»è€…ä»Ž GitHub èŽ·å–äº†ä½ çš„å¯†é’¥
LEAKED_KEY = "b01c66dc2c58dc6a0aabfe2144256be36226de378bf87f72c0c795dda67f4d55"

# æ”»å‡»è€…å¯ä»¥åšä»€ä¹ˆï¼Ÿ

# 1. ä¼ªé€ ç®¡ç†å‘˜ token
admin_token = jwt.encode({
    "user_id": 1,
    "username": "admin",
    "exp": datetime(2099, 12, 31)  # æ°¸ä¸è¿‡æœŸ
}, LEAKED_KEY)

# 2. è®¿é—®æ‰€æœ‰æŽ¥å£
headers = {"Authorization": f"Bearer {admin_token}"}
requests.get("https://your-api.com/admin/users", headers=headers)
# âœ… æˆåŠŸï¼ç³»ç»Ÿè®¤ä¸ºè¿™æ˜¯çœŸçš„ç®¡ç†å‘˜

# 3. åˆ é™¤æ•°æ®
requests.delete("https://your-api.com/admin/users/all", headers=headers)
# âœ… æˆåŠŸï¼æ‰€æœ‰ç”¨æˆ·è¢«åˆ é™¤

# 4. çªƒå–æ•°æ®
requests.get("https://your-api.com/admin/export/database", headers=headers)
# âœ… æˆåŠŸï¼æ•´ä¸ªæ•°æ®åº“è¢«å¯¼å‡º
```

### åœºæ™¯ 2: å¼€å‘å’Œç”Ÿäº§ä½¿ç”¨ç›¸åŒå¯†é’¥

```python
# é—®é¢˜ï¼šå¼€å‘å’Œç”Ÿäº§ç”¨åŒä¸€ä¸ªå¯†é’¥
SAME_KEY = "abc123"

# å¼€å‘çŽ¯å¢ƒï¼ˆä¸å®‰å…¨çš„ç½‘ç»œï¼‰
dev_token = jwt.encode({"user_id": 1}, SAME_KEY)

# è¿™ä¸ª token åœ¨ç”Ÿäº§çŽ¯å¢ƒä¹Ÿæœ‰æ•ˆï¼
# å¼€å‘äººå‘˜å¯èƒ½ï¼š
# 1. è¯¯æ“ä½œç”Ÿäº§æ•°æ®
# 2. æµ‹è¯•è´¦å·è®¿é—®ç”Ÿäº§çŽ¯å¢ƒ
# 3. å¼€å‘çŽ¯å¢ƒè¢«æ”»å‡»åŽï¼Œç”Ÿäº§çŽ¯å¢ƒä¹Ÿå—å½±å“
```

---

## ðŸ›¡ï¸ å®‰å…¨æœ€ä½³å®žè·µ

### 1. å¯†é’¥å¼ºåº¦

```python
# âŒ å¼±å¯†é’¥
JWT_SECRET_KEY = "123456"
JWT_SECRET_KEY = "admin"
JWT_SECRET_KEY = "myapp"

# âœ… å¼ºå¯†é’¥ï¼ˆè‡³å°‘ 32 å­—èŠ‚ï¼Œ256 ä½ï¼‰
JWT_SECRET_KEY = "b59c07901216ccade53f8f06a8d654395ed969aef23084fe55916df8927087b5"

# ç”Ÿæˆæ–¹æ³•
import secrets
JWT_SECRET_KEY = secrets.token_hex(32)  # 64 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦
```

### 2. çŽ¯å¢ƒéš”ç¦»

```python
# âœ… æ¯ä¸ªçŽ¯å¢ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥
# .env.dev
JWT_SECRET_KEY = "dev_key_b59c07901216ccade53f8f06a8d654395ed969aef23084fe55916df8927087b5"

# .env.prod
JWT_SECRET_KEY = "prod_key_75478341440b4dc5f69c9170e69e8dcc6f873227652cd1072be537f38beb592f"

# .env.dockermy
JWT_SECRET_KEY = "docker_mysql_2b1cbe5cf85e942e24e0b5e8c4629018c96b010ef84b3963f93532387ce271a8"
```

### 3. å¯†é’¥ä¿æŠ¤

```python
# âŒ ä¸è¦ç¡¬ç¼–ç 
JWT_SECRET_KEY = "b59c07901216ccade53f8f06a8d654395ed969aef23084fe55916df8927087b5"

# âœ… ä»ŽçŽ¯å¢ƒå˜é‡è¯»å–
import os
JWT_SECRET_KEY = os.getenv("JWT_SECRET_KEY")

if not JWT_SECRET_KEY:
    raise ValueError("JWT_SECRET_KEY æœªè®¾ç½®")

# âœ… ä»Žå¯†é’¥ç®¡ç†æœåŠ¡è¯»å–ï¼ˆç”Ÿäº§çŽ¯å¢ƒï¼‰
from azure.keyvault.secrets import SecretClient
JWT_SECRET_KEY = secret_client.get_secret("jwt-secret-key").value
```

### 4. å®šæœŸè½®æ¢

```python
# å»ºè®®æ¯ 3-6 ä¸ªæœˆæ›´æ¢ä¸€æ¬¡å¯†é’¥

# 1. ç”Ÿæˆæ–°å¯†é’¥
new_key = secrets.token_hex(32)

# 2. åŒæ—¶æ”¯æŒæ–°æ—§å¯†é’¥ï¼ˆè¿‡æ¸¡æœŸï¼‰
OLD_KEY = "old_key_..."
NEW_KEY = "new_key_..."

def verify_token(token):
    try:
        # å…ˆç”¨æ–°å¯†é’¥éªŒè¯
        return jwt.decode(token, NEW_KEY)
    except:
        # æ–°å¯†é’¥å¤±è´¥ï¼Œå°è¯•æ—§å¯†é’¥
        return jwt.decode(token, OLD_KEY)

# 3. ä¸€æ®µæ—¶é—´åŽï¼Œå®Œå…¨åˆ‡æ¢åˆ°æ–°å¯†é’¥
```

---

## ðŸ“Š å¯†é’¥å¯¹æ¯”

| ç‰¹æ€§ | å¼±å¯†é’¥ | å¼ºå¯†é’¥ |
|------|--------|--------|
| é•¿åº¦ | < 16 å­—ç¬¦ | â‰¥ 32 å­—èŠ‚ï¼ˆ64 å­—ç¬¦ï¼‰ |
| å¤æ‚åº¦ | ç®€å•å­—ç¬¦ä¸² | éšæœºåå…­è¿›åˆ¶ |
| å¯é¢„æµ‹æ€§ | é«˜ | ä½Ž |
| ç ´è§£æ—¶é—´ | ç§’/åˆ†é’Ÿ | æ•°ç™¾ä¸‡å¹´ |
| ç¤ºä¾‹ | `admin`, `123456` | `b59c07901216ccade...` |

---

## ðŸŽ¯ ä½ çš„ç³»ç»ŸçŽ°çŠ¶

### ä¿®å¤å‰
```python
# æ‰€æœ‰çŽ¯å¢ƒä½¿ç”¨ç›¸åŒå¯†é’¥
JWT_SECRET_KEY = "b01c66dc2c58dc6a0aabfe2144256be36226de378bf87f72c0c795dda67f4d55"

# é—®é¢˜ï¼š
# 1. å¼€å‘çŽ¯å¢ƒ token å¯åœ¨ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨
# 2. å¦‚æžœä¸€ä¸ªçŽ¯å¢ƒæ³„éœ²ï¼Œæ‰€æœ‰çŽ¯å¢ƒéƒ½ä¸å®‰å…¨
# 3. æ— æ³•ç‹¬ç«‹è½®æ¢æŸä¸ªçŽ¯å¢ƒçš„å¯†é’¥
```

### ä¿®å¤åŽ
```python
# æ¯ä¸ªçŽ¯å¢ƒç‹¬ç«‹å¯†é’¥
# å¼€å‘çŽ¯å¢ƒ
DEV_KEY = "b59c07901216ccade53f8f06a8d654395ed969aef23084fe55916df8927087b5"

# ç”Ÿäº§çŽ¯å¢ƒ
PROD_KEY = "75478341440b4dc5f69c9170e69e8dcc6f873227652cd1072be537f38beb592f"

# Docker MySQL
DOCKER_MY_KEY = "2b1cbe5cf85e942e24e0b5e8c4629018c96b010ef84b3963f93532387ce271a8"

# Docker PostgreSQL
DOCKER_PG_KEY = "8942300ae36408e724c5397e077b403dfbdf11df7c5e367d352e1081df4729ee"

# ä¼˜åŠ¿ï¼š
# âœ… çŽ¯å¢ƒéš”ç¦»
# âœ… ç‹¬ç«‹è½®æ¢
# âœ… é™ä½Žé£Žé™©
```

---

## ðŸ’¡ å¸¸è§é—®é¢˜

### Q1: å¯†é’¥å¯ä»¥æ”¹å—ï¼Ÿ
**A**: å¯ä»¥ï¼Œä½†ä¼šå¯¼è‡´æ‰€æœ‰çŽ°æœ‰ token å¤±æ•ˆï¼Œç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚

### Q2: å¯†é’¥æ³„éœ²äº†æ€Žä¹ˆåŠžï¼Ÿ
**A**: 
1. ç«‹å³ç”Ÿæˆæ–°å¯†é’¥
2. æ›´æ–°é…ç½®æ–‡ä»¶
3. é‡å¯æœåŠ¡
4. é€šçŸ¥æ‰€æœ‰ç”¨æˆ·é‡æ–°ç™»å½•
5. æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸è®¿é—®

### Q3: å¤šä¸ªæœåŠ¡å™¨éœ€è¦ç›¸åŒå¯†é’¥å—ï¼Ÿ
**A**: åŒä¸€ä¸ªçŽ¯å¢ƒçš„å¤šä¸ªæœåŠ¡å™¨éœ€è¦ä½¿ç”¨ç›¸åŒå¯†é’¥ï¼Œå¦åˆ™æ— æ³•éªŒè¯å½¼æ­¤ç”Ÿæˆçš„ tokenã€‚

### Q4: å¯†é’¥å­˜åœ¨å“ªé‡Œæœ€å®‰å…¨ï¼Ÿ
**A**: 
- å¼€å‘çŽ¯å¢ƒ: `.env` æ–‡ä»¶ï¼ˆä¸æäº¤åˆ° Gitï¼‰
- ç”Ÿäº§çŽ¯å¢ƒ: å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆAWS Secrets Manager, Azure Key Vault ç­‰ï¼‰

---

## ðŸ”— ç›¸å…³èµ„æº

- JWT å®˜æ–¹ç½‘ç«™: https://jwt.io/
- åœ¨çº¿ JWT è§£ç : https://jwt.io/#debugger
- Python JWT åº“: https://pyjwt.readthedocs.io/

---

**è®°ä½**: JWT å¯†é’¥å°±åƒä½ å®¶çš„é’¥åŒ™ï¼Œä¸€æ—¦æ³„éœ²ï¼Œä»»ä½•äººéƒ½èƒ½è¿›å…¥ä½ çš„ç³»ç»Ÿï¼
