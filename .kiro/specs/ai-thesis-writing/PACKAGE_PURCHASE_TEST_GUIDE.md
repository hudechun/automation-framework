# 套餐购买功能测试指南

## 测试前准备

### 1. 确保数据库已初始化
```bash
# 运行套餐初始化SQL（如果还没有）
mysql -u root -p ry-vue < RuoYi-Vue3-FastAPI/init_thesis_system.sql

# 运行支付配置初始化
mysql -u root -p ry-vue < RuoYi-Vue3-FastAPI/init_payment_configs.sql
```

### 2. 启动服务
```bash
# 启动后端
cd RuoYi-Vue3-FastAPI/ruoyi-fastapi-backend
python app.py

# 启动前端
cd RuoYi-Vue3-FastAPI/ruoyi-fastapi-frontend
npm run dev
```

## 测试步骤

### 测试1: 查看套餐列表
1. 登录系统（普通用户或管理员）
2. 访问菜单：**会员管理 > 会员套餐**
3. **预期结果**:
   - 显示套餐卡片网格
   - 每个套餐显示名称、价格、配额、功能列表
   - 推荐套餐有特殊标记
   - 每个套餐有"立即购买"按钮

### 测试2: 打开支付方式选择对话框
1. 点击任意套餐的"立即购买"按钮
2. **预期结果**:
   - 弹出支付方式选择对话框
   - 对话框标题为"选择支付方式"
   - 显示选中套餐的名称和价格
   - 显示可用支付渠道列表
   - 模拟支付默认选中

### 测试3: 选择支付方式
1. 在对话框中点击不同的支付渠道
2. **预期结果**:
   - 单选按钮状态正确切换
   - 选中项有蓝色边框和背景
   - 单选按钮内的圆点有动画效果

### 测试4: 创建订单（使用模拟支付）
1. 选择"模拟支付"
2. 点击"确认购买"按钮
3. **预期结果**:
   - 按钮显示"创建中..."
   - 显示成功提示"订单创建成功"
   - 自动跳转到订单列表页面
   - 订单列表中显示新创建的订单
   - 订单状态为"待支付"

### 测试5: 完成支付（模拟支付）
1. 在订单列表中找到刚创建的订单
2. 点击"模拟支付"按钮（橙色，仅管理员可见）
3. 确认对话框中点击"确认模拟支付"
4. **预期结果**:
   - 显示成功提示和交易号
   - 订单状态变为"已支付"
   - 用户配额自动增加

### 测试6: 验证配额增加
1. 访问菜单：**会员管理 > 配额管理**
2. **预期结果**:
   - 字数配额增加了套餐对应的数量
   - 使用次数配额增加了套餐对应的数量
   - 有效期延长了套餐对应的天数

## 错误场景测试

### 测试7: 未选择支付方式
1. 打开支付方式对话框
2. 不选择任何支付方式（取消默认选中）
3. 点击"确认购买"
4. **预期结果**:
   - 显示警告提示"请选择支付方式"
   - 不创建订单

### 测试8: 网络错误处理
1. 断开网络或停止后端服务
2. 尝试创建订单
3. **预期结果**:
   - 显示错误提示
   - 按钮恢复正常状态
   - 对话框保持打开

### 测试9: 取消购买
1. 打开支付方式对话框
2. 点击"取消"按钮或关闭按钮
3. **预期结果**:
   - 对话框关闭
   - 不创建订单
   - 停留在套餐页面

## UI/UX 测试

### 测试10: 响应式设计
1. 调整浏览器窗口大小
2. **预期结果**:
   - 套餐卡片自适应布局
   - 移动端显示单列
   - 对话框在小屏幕上正常显示

### 测试11: 动画效果
1. 悬停在套餐卡片上
2. 点击支付渠道选项
3. **预期结果**:
   - 卡片有上浮动画
   - 单选按钮有缩放动画
   - 所有过渡流畅自然

### 测试12: 加载状态
1. 观察页面加载过程
2. 观察创建订单过程
3. **预期结果**:
   - 套餐列表加载时显示 loading
   - 创建订单时按钮显示"创建中..."
   - 按钮在加载时禁用

## 多用户测试

### 测试13: 普通用户购买
1. 使用普通用户账号登录
2. 完成购买流程
3. **预期结果**:
   - 可以正常浏览套餐
   - 可以创建订单
   - 不能看到"模拟支付"按钮
   - 需要真实支付或管理员帮助

### 测试14: 管理员购买
1. 使用管理员账号登录
2. 完成购买流程
3. **预期结果**:
   - 可以看到"模拟支付"按钮
   - 可以直接模拟支付完成
   - 可以查看所有用户的订单

## 数据验证

### 测试15: 订单数据完整性
1. 创建订单后查询数据库
```sql
SELECT * FROM ai_write_order WHERE order_type = 'package' ORDER BY create_time DESC LIMIT 1;
```
2. **预期字段**:
   - `order_no`: 订单号（唯一）
   - `user_id`: 用户ID
   - `order_type`: 'package'
   - `item_id`: 套餐ID
   - `amount`: 金额
   - `status`: 'pending'
   - `payment_method`: 选择的支付方式

### 测试16: 支付后数据更新
1. 模拟支付后查询数据库
```sql
-- 查询订单状态
SELECT status, paid_at FROM ai_write_order WHERE order_no = '订单号';

-- 查询交易记录
SELECT * FROM ai_write_payment_transaction WHERE order_no = '订单号';

-- 查询配额变化
SELECT * FROM ai_write_member_quota WHERE user_id = 用户ID;
```
2. **预期结果**:
   - 订单状态变为 'paid'
   - `paid_at` 有值
   - 交易记录已创建
   - 配额已增加

## 性能测试

### 测试17: 并发购买
1. 多个用户同时购买同一套餐
2. **预期结果**:
   - 所有订单都能成功创建
   - 订单号不重复
   - 没有数据冲突

### 测试18: 页面加载速度
1. 清除缓存后访问套餐页面
2. **预期结果**:
   - 页面在2秒内加载完成
   - 套餐列表在1秒内显示
   - 支付渠道在1秒内加载

## 测试检查清单

- [ ] 套餐列表正确显示
- [ ] 支付方式对话框正常打开
- [ ] 支付渠道正确加载
- [ ] 订单创建成功
- [ ] 跳转到订单列表
- [ ] 模拟支付功能正常
- [ ] 配额正确增加
- [ ] 错误提示正确显示
- [ ] 响应式设计正常
- [ ] 动画效果流畅
- [ ] 加载状态正确
- [ ] 数据完整性验证通过

## 常见问题排查

### 问题1: 支付渠道列表为空
**原因**: 没有启用的支付配置
**解决**: 运行 `init_payment_configs.sql` 初始化支付配置

### 问题2: 创建订单失败
**原因**: 套餐不存在或金额不匹配
**解决**: 检查套餐数据是否正确，金额是否一致

### 问题3: 模拟支付按钮不显示
**原因**: 不是管理员账号
**解决**: 使用管理员账号登录（admin/admin123）

### 问题4: 配额没有增加
**原因**: 支付回调处理失败
**解决**: 检查 `OrderService.process_payment()` 日志

## 测试报告模板

```
测试日期: ____________________
测试人员: ____________________
测试环境: ____________________

功能测试:
- 套餐展示: [ ] 通过 [ ] 失败
- 支付选择: [ ] 通过 [ ] 失败
- 订单创建: [ ] 通过 [ ] 失败
- 支付完成: [ ] 通过 [ ] 失败
- 配额增加: [ ] 通过 [ ] 失败

UI/UX测试:
- 响应式设计: [ ] 通过 [ ] 失败
- 动画效果: [ ] 通过 [ ] 失败
- 加载状态: [ ] 通过 [ ] 失败

错误处理:
- 未选择支付方式: [ ] 通过 [ ] 失败
- 网络错误: [ ] 通过 [ ] 失败
- 取消购买: [ ] 通过 [ ] 失败

发现的问题:
1. ________________________________
2. ________________________________
3. ________________________________

总体评价: [ ] 优秀 [ ] 良好 [ ] 需改进
```
